# ğŸ—ï¸ Lee's POS ç³»çµ±æ¶æ§‹èªªæ˜

## ğŸ“Š ç³»çµ±æ¦‚è¦½

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          Vercel éœæ…‹è¨—ç®¡                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚  â”‚              â”‚  â”‚              â”‚  â”‚              â”‚              â”‚
â”‚  â”‚  å“¡å·¥é»é¤     â”‚  â”‚  å®¢äººé»é¤     â”‚  â”‚  å¾Œå°ç®¡ç†     â”‚              â”‚
â”‚  â”‚ employee-pos â”‚  â”‚    pos.html  â”‚  â”‚  admin.html  â”‚              â”‚
â”‚  â”‚    .html     â”‚  â”‚              â”‚  â”‚              â”‚              â”‚
â”‚  â”‚              â”‚  â”‚              â”‚  â”‚              â”‚              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚         â”‚                 â”‚                 â”‚                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                 â”‚                 â”‚
          â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚      â”‚                                        â”‚
          â””â”€â”€â”€â”€â”€â”€â–º    Supabaseï¼ˆæ ¸å¿ƒè³‡æ–™åº« + APIï¼‰        â”‚
                 â”‚                                        â”‚
                 â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
                 â”‚  â”‚     PostgreSQL Database          â”‚ â”‚
                 â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚
                 â”‚  â”‚  â”‚ â€¢ menu_items (èœå–®)         â”‚  â”‚ â”‚
                 â”‚  â”‚  â”‚ â€¢ orders (è¨‚å–®)             â”‚  â”‚ â”‚
                 â”‚  â”‚  â”‚ â€¢ order_items (è¨‚å–®é …ç›®)    â”‚  â”‚ â”‚
                 â”‚  â”‚  â”‚ â€¢ staff_users (å“¡å·¥)        â”‚  â”‚ â”‚
                 â”‚  â”‚  â”‚ â€¢ staff_sessions (ç™»å…¥)     â”‚  â”‚ â”‚
                 â”‚  â”‚  â”‚ â€¢ login_attempts (å®‰å…¨)     â”‚  â”‚ â”‚
                 â”‚  â”‚  â”‚ â€¢ inventory_items (åº«å­˜)    â”‚  â”‚ â”‚
                 â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚
                 â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
                 â”‚                                        â”‚
                 â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
                 â”‚  â”‚     RPC Functions (å®‰å…¨å±¤)        â”‚ â”‚
                 â”‚  â”‚  â€¢ attempt_staff_login()         â”‚ â”‚
                 â”‚  â”‚  â€¢ create_order_with_items()     â”‚ â”‚
                 â”‚  â”‚  â€¢ decrement_inventory()         â”‚ â”‚
                 â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
                 â”‚                                        â”‚
                 â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
                 â”‚  â”‚     Row Level Security (RLS)      â”‚ â”‚
                 â”‚  â”‚  â€¢ é˜²æ­¢æœªæˆæ¬Šå­˜å–                  â”‚ â”‚
                 â”‚  â”‚  â€¢ åŸºæ–¼ session token é©—è­‰        â”‚ â”‚
                 â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ¯ ä¸‰å¤§ç³»çµ±è©³ç´°èªªæ˜

### 1ï¸âƒ£ å“¡å·¥é»é¤ç³»çµ± (employee-pos.html)

**åŠŸèƒ½ï¼š**
- âœ… PIN ç¢¼ç™»å…¥ï¼ˆ4ä½æ•¸å¯†ç¢¼ï¼‰
- âœ… ç€è¦½èœå–®ä¸¦åŠ å…¥è³¼ç‰©è»Š
- âœ… é¸æ“‡å…§ç”¨/å¤–å¸¶
- âœ… æ”¯æ´ç¾é‡‘ã€åˆ·å¡ã€å…¶ä»–ä»˜æ¬¾æ–¹å¼
- âœ… æŸ¥çœ‹ä»Šæ—¥è¨‚å–®

**èˆ‡ Supabase çš„é€£æ¥ï¼š**
```javascript
// 1. ç™»å…¥é©—è­‰ï¼ˆä½¿ç”¨ RPCï¼‰
supabase.rpc('attempt_staff_login', {
    p_pin_code: '1111',
    p_ip_address: 'device_ip',
    p_device_info: 'browser_info'
})
// è¿”å›ï¼šsession_tokenï¼ˆ12å°æ™‚æœ‰æ•ˆï¼‰

// 2. è®€å–èœå–®
supabase.from('menu_items').select('*')

// 3. å»ºç«‹è¨‚å–®ï¼ˆä½¿ç”¨ RPCï¼Œè‡ªå‹•æ‰£åº«å­˜ï¼‰
supabase.rpc('create_order_with_items', {
    p_session_token: token,
    p_order_type: 'dine_in',
    p_payment_method: 'cash',
    p_items: [...],
    p_subtotal: 100,
    p_tax: 8.25,
    p_total_price: 108.25
})
```

**å®‰å…¨æ©Ÿåˆ¶ï¼š**
- ğŸ” ç™»å…¥å¤±æ•— 5 æ¬¡é–å®š 15 åˆ†é˜
- ğŸ” Session token é©—è­‰ï¼ˆä¸ç›´æ¥å­˜å–è³‡æ–™åº«ï¼‰
- ğŸ” æ‰€æœ‰æ“ä½œè¨˜éŒ„åœ¨ login_attempts è¡¨

---

### 2ï¸âƒ£ å®¢äººé»é¤ç³»çµ± (pos.html)

**åŠŸèƒ½ï¼š**
- âœ… ç„¡éœ€ç™»å…¥ï¼ˆå…¬é–‹è¨ªå•ï¼‰
- âœ… ç€è¦½èœå–®ä¸¦åŠ å…¥è³¼ç‰©è»Š
- âœ… é¸æ“‡å…§ç”¨/å¤–å¸¶
- âœ… æ”¯æ´ç¾é‡‘ã€åˆ·å¡ã€å…¶ä»–ä»˜æ¬¾æ–¹å¼

**èˆ‡ Supabase çš„é€£æ¥ï¼š**
```javascript
// 1. è®€å–èœå–®ï¼ˆå…¬é–‹å­˜å–ï¼‰
supabase.from('menu_items').select('*')

// 2. å»ºç«‹è¨‚å–®ï¼ˆä½¿ç”¨åŒ¿åæ¬Šé™ï¼‰
supabase.from('orders').insert({...})
supabase.from('order_items').insert([...])
```

**å·®ç•°ï¼š**
- âŒ ä¸éœ€è¦å“¡å·¥ç™»å…¥
- âŒ ä¸è¨˜éŒ„æ“ä½œå“¡è³‡è¨Š
- âœ… ä½¿ç”¨ Supabase anon keyï¼ˆå…¬é–‹ APIï¼‰

---

### 3ï¸âƒ£ å¾Œå°ç®¡ç†ç³»çµ± (admin.html)

**åŠŸèƒ½ï¼š**
- âœ… æŸ¥çœ‹æ‰€æœ‰è¨‚å–®
- âœ… ç®¡ç†èœå–®ï¼ˆæ–°å¢ã€ç·¨è¼¯ã€åˆªé™¤ï¼‰
- âœ… ç®¡ç†åº«å­˜
- âœ… æŸ¥çœ‹ç‡Ÿæ”¶å ±è¡¨
- âœ… ç®¡ç†å“¡å·¥å¸³è™Ÿ

**èˆ‡ Supabase çš„é€£æ¥ï¼š**
```javascript
// 1. è®€å–æ‰€æœ‰è¨‚å–®ï¼ˆéœ€è¦ admin æ¬Šé™ï¼‰
supabase.from('orders')
    .select('*, order_items(*)')
    .order('created_at', { ascending: false })

// 2. ç®¡ç†èœå–®
supabase.from('menu_items').insert({...})
supabase.from('menu_items').update({...}).eq('id', id)
supabase.from('menu_items').delete().eq('id', id)

// 3. ç®¡ç†åº«å­˜
supabase.from('inventory_items').select('*')
supabase.from('inventory_items').update({ quantity })

// 4. ç‡Ÿæ”¶å ±è¡¨
supabase.from('orders')
    .select('total_price, created_at')
    .gte('created_at', startDate)
```

**å®‰å…¨è€ƒé‡ï¼š**
- âš ï¸ ç›®å‰ä½¿ç”¨ anon keyï¼ˆéœ€è¦åŠ å¼·æ¬Šé™æ§åˆ¶ï¼‰
- ğŸ”’ å»ºè­°ï¼šæ‡‰è©²è¦æœ‰ç®¡ç†å“¡ç™»å…¥ç³»çµ±
- ğŸ”’ å»ºè­°ï¼šä½¿ç”¨ RLS é™åˆ¶åªæœ‰ç®¡ç†å“¡èƒ½ä¿®æ”¹èœå–®

---

## ğŸ”„ è³‡æ–™æµå‘åœ–

### è¨‚å–®å»ºç«‹æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ä½¿ç”¨è€…é¸æ“‡å•†å“ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ åŠ å…¥è³¼ç‰©è»Š     â”‚  (å‰ç«¯ç‹€æ…‹ç®¡ç†)
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ é»æ“Šä»˜æ¬¾æŒ‰éˆ•   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å‘¼å« RPC: create_order_with_items   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Supabase RPC å‡½æ•¸           â”‚
â”‚  1. é©—è­‰ session token (å“¡å·¥)       â”‚
â”‚  2. INSERT INTO orders              â”‚
â”‚  3. INSERT INTO order_items (æ‰¹æ¬¡)  â”‚
â”‚  4. æ‰£é™¤åº«å­˜ (decrement_inventory)  â”‚
â”‚  5. è¿”å› order_id                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å‰ç«¯é¡¯ç¤ºæˆåŠŸè¨Šæ¯ï¼ˆToastï¼‰           â”‚
â”‚  "è¨‚å–® #12345 å·²å®Œæˆ"               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ’³ æœªä¾†æ•´åˆ Stripe æ”¯ä»˜æ–¹æ¡ˆ

### ğŸ¯ ç›®æ¨™
è®“å®¢äººé»é¤ç³»çµ±æ”¯æ´ç·šä¸Šä¿¡ç”¨å¡ä»˜æ¬¾ï¼ˆStripeï¼‰

### ğŸ“ æ¶æ§‹è¨­è¨ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     å®¢äººé»é¤ç³»çµ± (pos.html)                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  1. å®¢äººé¸æ“‡å•†å“ â†’ åŠ å…¥è³¼ç‰©è»Š                               â”‚  â”‚
â”‚  â”‚  2. é»æ“Šã€ŒğŸ’³ ä¿¡ç”¨å¡ä»˜æ¬¾ã€æŒ‰éˆ•                               â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚   Stripe Checkout Session  â”‚
        â”‚  (åœ¨ Stripe ç¶²ç«™å®Œæˆä»˜æ¬¾)   â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â”‚ [ä»˜æ¬¾æˆåŠŸ]
                     â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚   Stripe Webhook å›èª¿       â”‚
        â”‚  POST /api/stripe/webhook   â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚    Vercel Serverless Function      â”‚
        â”‚  (æ¥æ”¶ Stripe webhook é€šçŸ¥)         â”‚
        â”‚  1. é©—è­‰ Stripe ç°½å                â”‚
        â”‚  2. å‘¼å« Supabase RPC               â”‚
        â”‚  3. å»ºç«‹è¨‚å–® + æ‰£åº«å­˜               â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚       Supabase Database            â”‚
        â”‚  INSERT INTO orders                â”‚
        â”‚  payment_method = 'stripe'         â”‚
        â”‚  stripe_payment_id = 'pi_xxxxx'    â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ğŸ› ï¸ å¯¦ä½œæ­¥é©Ÿ

#### Step 1: åœ¨ Supabase æ–°å¢ Stripe ç›¸é—œæ¬„ä½

```sql
-- æ“´å…… orders è¡¨
ALTER TABLE orders ADD COLUMN stripe_payment_intent_id TEXT;
ALTER TABLE orders ADD COLUMN stripe_checkout_session_id TEXT;
ALTER TABLE orders ADD COLUMN payment_status TEXT DEFAULT 'pending';
-- payment_status: pending, completed, failed, refunded

CREATE INDEX idx_orders_stripe_payment_intent
ON orders(stripe_payment_intent_id);
```

#### Step 2: å»ºç«‹ Vercel Serverless API

åœ¨å°ˆæ¡ˆæ–°å¢ `api/stripe/webhook.js`ï¼š

```javascript
// /api/stripe/webhook.js
import Stripe from 'stripe';
import { createClient } from '@supabase/supabase-js';

const stripe = new Stripe(process.env.STRIPE_SECRET_KEY);
const supabase = createClient(
    process.env.SUPABASE_URL,
    process.env.SUPABASE_SERVICE_ROLE_KEY // ä½¿ç”¨ service role key
);

export default async function handler(req, res) {
    if (req.method !== 'POST') {
        return res.status(405).json({ error: 'Method not allowed' });
    }

    const sig = req.headers['stripe-signature'];
    let event;

    try {
        // é©—è­‰ Stripe webhook ç°½å
        event = stripe.webhooks.constructEvent(
            req.body,
            sig,
            process.env.STRIPE_WEBHOOK_SECRET
        );
    } catch (err) {
        return res.status(400).json({ error: `Webhook Error: ${err.message}` });
    }

    // è™•ç†ä»˜æ¬¾æˆåŠŸäº‹ä»¶
    if (event.type === 'checkout.session.completed') {
        const session = event.data.object;
        const { order_data } = session.metadata; // å¾ metadata å–å¾—è¨‚å–®è³‡æ–™

        // å»ºç«‹è¨‚å–®
        const { data, error } = await supabase.rpc('create_order_with_items', {
            p_session_token: null, // Stripe ä»˜æ¬¾ä¸éœ€è¦å“¡å·¥ token
            p_order_type: order_data.order_type,
            p_payment_method: 'stripe',
            p_items: JSON.parse(order_data.items),
            p_subtotal: order_data.subtotal,
            p_tax: order_data.tax,
            p_total_price: session.amount_total / 100, // Stripe é‡‘é¡æ˜¯åˆ†ç‚ºå–®ä½
            p_stripe_payment_intent_id: session.payment_intent,
            p_stripe_checkout_session_id: session.id
        });

        if (error) {
            console.error('å»ºç«‹è¨‚å–®å¤±æ•—:', error);
            return res.status(500).json({ error: 'Failed to create order' });
        }

        console.log('âœ… Stripe è¨‚å–®å»ºç«‹æˆåŠŸ:', data);
    }

    res.status(200).json({ received: true });
}
```

#### Step 3: å‰ç«¯æ•´åˆ Stripe Checkout

ä¿®æ”¹ `pos.html`ï¼š

```javascript
// æ–°å¢ Stripe ä»˜æ¬¾æŒ‰éˆ•
const handleStripeCheckout = async () => {
    const response = await fetch('/api/stripe/create-checkout', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            items: cart,
            order_type: orderType,
            subtotal: cartStats.subtotal,
            tax: cartStats.tax,
            total: cartStats.total
        })
    });

    const { url } = await response.json();
    window.location.href = url; // è·³è½‰åˆ° Stripe ä»˜æ¬¾é é¢
};

// ä»˜æ¬¾æŒ‰éˆ•
<button className="pay-btn stripe" onClick={handleStripeCheckout}>
    ğŸ’³ Stripe ä»˜æ¬¾
</button>
```

#### Step 4: å»ºç«‹ Checkout Session API

æ–°å¢ `api/stripe/create-checkout.js`ï¼š

```javascript
import Stripe from 'stripe';
const stripe = new Stripe(process.env.STRIPE_SECRET_KEY);

export default async function handler(req, res) {
    const { items, order_type, subtotal, tax, total } = req.body;

    // å»ºç«‹ Stripe Checkout Session
    const session = await stripe.checkout.sessions.create({
        payment_method_types: ['card'],
        line_items: items.map(item => ({
            price_data: {
                currency: 'usd',
                product_data: {
                    name: item.name,
                },
                unit_amount: Math.round(item.price * 100), // è½‰æˆåˆ†
            },
            quantity: item.quantity,
        })),
        mode: 'payment',
        success_url: `${process.env.VERCEL_URL}/order-success.html?session_id={CHECKOUT_SESSION_ID}`,
        cancel_url: `${process.env.VERCEL_URL}/pos.html`,
        metadata: {
            order_data: JSON.stringify({
                order_type,
                items,
                subtotal,
                tax
            })
        }
    });

    res.status(200).json({ url: session.url });
}
```

---

### ğŸ” Stripe ç’°å¢ƒè®Šæ•¸è¨­å®š

åœ¨ Vercel Dashboard è¨­å®šï¼š

```env
STRIPE_SECRET_KEY=sk_live_xxxxxxxxxxxxx
STRIPE_WEBHOOK_SECRET=whsec_xxxxxxxxxxxxx
SUPABASE_URL=https://xxxxx.supabase.co
SUPABASE_SERVICE_ROLE_KEY=eyJxxx... (å¾ Supabase å–å¾—)
```

---

### ğŸ“‹ Stripe æ•´åˆ Checklist

- [ ] è¨»å†Š Stripe å¸³è™Ÿï¼ˆhttps://stripe.comï¼‰
- [ ] å–å¾— API Keysï¼ˆSecret Key + Publishable Keyï¼‰
- [ ] åœ¨ Vercel è¨­å®šç’°å¢ƒè®Šæ•¸
- [ ] å»ºç«‹ `/api/stripe/create-checkout.js`
- [ ] å»ºç«‹ `/api/stripe/webhook.js`
- [ ] åœ¨ Stripe Dashboard è¨­å®š Webhook URL
  - URL: `https://ä½ çš„ç¶²åŸŸ.vercel.app/api/stripe/webhook`
  - ç›£è½äº‹ä»¶: `checkout.session.completed`
- [ ] ä¿®æ”¹ `pos.html` åŠ å…¥ Stripe ä»˜æ¬¾æŒ‰éˆ•
- [ ] æ¸¬è©¦æµç¨‹ï¼ˆä½¿ç”¨ Stripe Test Modeï¼‰
- [ ] ä¸Šç·šå‰åˆ‡æ›åˆ° Live Mode

---

## ğŸ”’ å®‰å…¨å»ºè­°

### ç›®å‰ç³»çµ±çš„å®‰å…¨é¢¨éšª

1. **å¾Œå°ç®¡ç†æ²’æœ‰ç™»å…¥ç³»çµ±** âš ï¸
   - ä»»ä½•äººéƒ½èƒ½è¨ªå• admin.html
   - å»ºè­°ï¼šåŠ å…¥ç®¡ç†å“¡ç™»å…¥ï¼ˆPIN æˆ–å¯†ç¢¼ï¼‰

2. **å®¢äººé»é¤ä½¿ç”¨ anon key** âš ï¸
   - å¯èƒ½è¢«æ¿«ç”¨ï¼ˆå¤§é‡å»ºç«‹å‡è¨‚å–®ï¼‰
   - å»ºè­°ï¼šåŠ å…¥ Rate Limitingï¼ˆé™åˆ¶æ¯ IP æ¯åˆ†é˜å»ºç«‹è¨‚å–®æ•¸ï¼‰

3. **æ²’æœ‰ Realtime åŒæ­¥** âš ï¸
   - éœ€è¦æ‰‹å‹•åˆ·æ–°æ‰èƒ½çœ‹åˆ°å…¶ä»–ç³»çµ±çš„æ›´æ–°
   - å»ºè­°ï¼šä½¿ç”¨ Supabase Realtime è¨‚é–±

### æ¨è–¦åŠ å¼·é …ç›®

```javascript
// 1. åŠ å…¥ Rate Limiting (Supabase Edge Function)
export async function rateLimit(ip: string) {
    const count = await redis.incr(`rate:${ip}`);
    if (count === 1) await redis.expire(`rate:${ip}`, 60); // 1åˆ†é˜éæœŸ
    if (count > 10) throw new Error('Too many requests');
}

// 2. åŠ å…¥è¨‚å–®é©—è­‰
CREATE OR REPLACE FUNCTION validate_order_amount(
    p_items JSONB,
    p_total_price DECIMAL
) RETURNS BOOLEAN AS $$
DECLARE
    calculated_total DECIMAL;
BEGIN
    -- è¨ˆç®—å¯¦éš›ç¸½é‡‘é¡ï¼ˆé˜²æ­¢å‰ç«¯ç«„æ”¹åƒ¹æ ¼ï¼‰
    SELECT SUM((item->>'price')::DECIMAL * (item->>'quantity')::INT)
    INTO calculated_total
    FROM jsonb_array_elements(p_items) AS item;

    RETURN ABS(calculated_total - p_total_price) < 0.01;
END;
$$ LANGUAGE plpgsql;
```

---

## ğŸ“Š è³‡æ–™åº«è¡¨æ ¼é—œä¿‚åœ–

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   staff_users   â”‚
â”‚  â”œâ”€ id (PK)     â”‚
â”‚  â”œâ”€ username    â”‚
â”‚  â”œâ”€ pin_code    â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â””â”€ role        â”‚          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
                              â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚ staff_sessions  â”‚          â”‚
â”‚  â”œâ”€ id (PK)     â”‚          â”‚
â”‚  â”œâ”€ staff_id    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚  â”œâ”€ session_token
â”‚  â””â”€ expires_at  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â”‚ (é©—è­‰)
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     orders      â”‚       â”‚   menu_items    â”‚
â”‚  â”œâ”€ id (PK)     â”‚       â”‚  â”œâ”€ id (PK)     â”‚
â”‚  â”œâ”€ staff_id    â”‚       â”‚  â”œâ”€ name        â”‚
â”‚  â”œâ”€ order_type  â”‚       â”‚  â”œâ”€ price       â”‚
â”‚  â”œâ”€ payment_... â”‚       â”‚  â”œâ”€ category    â”‚
â”‚  â””â”€ total_price â”‚       â”‚  â””â”€ available   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                         â”‚
         â”‚ (1 å°å¤š)                â”‚
         â–¼                         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚  order_items    â”‚                â”‚
â”‚  â”œâ”€ id (PK)     â”‚                â”‚
â”‚  â”œâ”€ order_id    â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚  â”œâ”€ item_id     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â”œâ”€ quantity    â”‚                  â”‚
â”‚  â””â”€ price       â”‚                  â–¼
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                          â”‚ menu_packaging_map  â”‚
                          â”‚  â”œâ”€ menu_item_name  â”‚
                          â”‚  â”œâ”€ inventory_item_idâ”‚â”€â”
                          â”‚  â””â”€ qty_per_sale    â”‚ â”‚
                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
                                                  â”‚
                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
                          â”‚  inventory_items    â”‚â—„â”˜
                          â”‚  â”œâ”€ id (PK)         â”‚
                          â”‚  â”œâ”€ name            â”‚
                          â”‚  â”œâ”€ quantity        â”‚
                          â”‚  â””â”€ unit            â”‚
                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸš€ æœªä¾†æ“´å……æ–¹å‘

1. **å¯¦æ™‚è¨‚å–®æ›´æ–°**
   - ä½¿ç”¨ Supabase Realtime
   - å»šæˆ¿é¡¯ç¤ºè‡ªå‹•æ›´æ–°

2. **æœƒå“¡ç³»çµ±**
   - å®¢äººè¨»å†Š/ç™»å…¥
   - ç´¯ç©é»æ•¸/å„ªæƒ åˆ¸

3. **å ±è¡¨åˆ†æ**
   - æ¯æ—¥/æ¯æœˆç‡Ÿæ”¶å ±è¡¨
   - ç†±éŠ·å•†å“åˆ†æ
   - åº«å­˜è­¦å ±

4. **å¤šèªç³»æ”¯æ´**
   - è‹±æ–‡/ä¸­æ–‡åˆ‡æ›
   - å„²å­˜åœ¨ Supabase

5. **è¡Œå‹• App**
   - React Native
   - ä½¿ç”¨ç›¸åŒ Supabase API

---

**ğŸ“ æ–‡ä»¶ç‰ˆæœ¬ï¼š** v1.0
**ğŸ“… æœ€å¾Œæ›´æ–°ï¼š** 2026-02-20
**ğŸ‘¨â€ğŸ’» ç¶­è­·è€…ï¼š** Lee's POS Team
