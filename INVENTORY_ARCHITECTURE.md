# ğŸ“¦ åº“å­˜ç®¡ç†ç³»ç»Ÿæ¶æ„è®¾è®¡

## ğŸ¯ æ ¸å¿ƒåŸåˆ™ï¼šSingle Source of Truth

### æ•°æ®æµå‘ï¼ˆå”¯ä¸€çœŸç›¸æ¥æºï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  æ•°æ®ä¿®æ”¹å”¯ä¸€å…¥å£                          â”‚
â”‚                  â†“ RPC Functions Only â†“                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â†“                   â†“                   â†“
   receive_inventory()  deduct_inventory_fifo() quick_adjustment()
        â”‚                   â”‚                   â”‚
        â†“                   â†“                   â†“
   inventory_batches    inventory_batches   inventory_batches
   (qty_remaining)      (qty_remaining)     (qty_remaining)
        â”‚                   â”‚                   â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
                  inventory_transactions
                  (å®Œæ•´å®¡è®¡è¿½è¸ª - Ledger)
```

---

## ğŸ“‹ è¡¨ç»“æ„èŒè´£åˆ’åˆ†

### 1ï¸âƒ£ `inventory_batches` - **ç‰©ç†åº“å­˜ï¼ˆSource of Truthï¼‰**

**èŒè´£**ï¼šå­˜å‚¨å®é™…åº“å­˜æ•°é‡

| å­—æ®µ | ç”¨é€” | è°å¯ä»¥ä¿®æ”¹ |
|------|------|-----------|
| `qty_received` | å…¥åº“æ€»é‡ | âœ… receive_inventory() |
| `qty_remaining` | **å½“å‰å‰©ä½™é‡** | âœ… **åªèƒ½é€šè¿‡å‡½æ•°ä¿®æ”¹** |
| `is_active` | æ˜¯å¦æ´»è·ƒæ‰¹æ¬¡ | âœ… deduct_inventory_fifo() è‡ªåŠ¨ç®¡ç† |
| `cost_per_unit` | æ‰¹æ¬¡æˆæœ¬ | âœ… receive_inventory() |

**è§„åˆ™**ï¼š
- âœ… `qty_remaining` æ˜¯ **å”¯ä¸€çœŸç›¸æ¥æº**
- âŒ å‰ç«¯ **ç¦æ­¢** ç›´æ¥ä¿®æ”¹
- âœ… åªèƒ½é€šè¿‡ RPC å‡½æ•°ä¿®æ”¹
- âœ… é€šè¿‡ RLS ç­–ç•¥å¼ºåˆ¶æ‰§è¡Œ

---

### 2ï¸âƒ£ `inventory_transactions` - **å®¡è®¡è¿½è¸ªï¼ˆLedgerï¼‰**

**èŒè´£**ï¼šè®°å½•æ‰€æœ‰åº“å­˜å˜åŠ¨å†å²

| å­—æ®µ | ç”¨é€” |
|------|------|
| `transaction_type` | in/outï¼ˆå…¥åº“/å‡ºåº“ï¼‰ |
| `qty` | å˜åŠ¨æ•°é‡ |
| `reference_type` | å…³è”ç±»å‹ï¼ˆorder/adjustment/receiveï¼‰ |
| `reference_id` | å…³è”è®¢å• ID |
| `created_at` | äº¤æ˜“æ—¶é—´ |

**è§„åˆ™**ï¼š
- âœ… æ¯æ¬¡åº“å­˜å˜åŠ¨ **å¿…é¡»** å†™å…¥ transaction
- âŒ **ç¦æ­¢** ç›´æ¥å†™å…¥ï¼ˆåªèƒ½é€šè¿‡å‡½æ•°ï¼‰
- âœ… ç”¨äºå®¡è®¡ã€æŠ¥è¡¨ã€æˆæœ¬è®¡ç®—
- âœ… ä¸å¯ä¿®æ”¹ï¼ˆAppend-onlyï¼‰

**å…³ç³»**ï¼š
```
qty_remaining (ç°åœ¨) = åˆå§‹åº“å­˜ + SUM(transactions)
                     = qty_received - SUM(out transactions)
```

---

### 3ï¸âƒ£ `inventory_adjustments` - **è°ƒæ•´è®°å½•**

**èŒè´£**ï¼šè®°å½•ç›˜ç‚¹è°ƒæ•´ã€å‘˜å·¥é¤ã€æŠ¥åºŸã€èµ é€

| å­—æ®µ | ç”¨é€” |
|------|------|
| `adjustment_type` | staff_meal/waste/gift/count_adjustment |
| `qty_change` | å˜åŠ¨æ•°é‡ï¼ˆæ­£/è´Ÿï¼‰ |
| `cost_impact` | æˆæœ¬å½±å“ |
| `reason` | è°ƒæ•´åŸå›  |

**è§„åˆ™**ï¼š
- âœ… è¾…åŠ©è®°å½•ï¼Œç”¨äºåˆ†æå‘˜å·¥é¤æˆæœ¬ã€æŠ¥åºŸç‡
- âœ… ä¸å½±å“ qty_remainingï¼ˆå·²é€šè¿‡ transaction æ‰£é™¤ï¼‰

---

## ğŸ”„ æ•°æ®ä¸€è‡´æ€§ä¿è¯

### æ–¹å¼ 1ï¼šå‡½æ•°å†…éƒ¨å¼ºåˆ¶å†™å…¥ transactionï¼ˆâœ… å½“å‰é‡‡ç”¨ï¼‰

```sql
CREATE FUNCTION deduct_inventory_fifo(...) AS $$
BEGIN
    -- 1. æ›´æ–° batches
    UPDATE inventory_batches
    SET qty_remaining = qty_remaining - v_qty;

    -- 2. å¼ºåˆ¶å†™å…¥ transaction
    INSERT INTO inventory_transactions (...);

    -- 3. åœ¨åŒä¸€äº‹åŠ¡ä¸­ï¼Œä¿è¯ä¸€è‡´æ€§
    RETURN ...;
END;
$$;
```

**ä¼˜åŠ¿**ï¼š
- âœ… åŸå­æ“ä½œï¼ˆtransaction å†…ï¼‰
- âœ… ä¸å¯èƒ½å‡ºç°ä¸ä¸€è‡´
- âœ… qty_remaining å’Œ transactions æ°¸è¿œåŒæ­¥

---

## ğŸš€ é—®é¢˜ 3ï¼šè®¢å•-åº“å­˜é›†æˆæµç¨‹

### å½“å‰ç¼ºå¤±ï¼šè®¢å•å®Œæˆ â†’ è‡ªåŠ¨æ‰£åº“å­˜

**ç°çŠ¶**ï¼š
- âŒ è®¢å•æäº¤æ—¶ï¼Œæ²¡æœ‰æ‰£åº“å­˜
- âŒ è®¢å•çŠ¶æ€å˜æ›´æ—¶ï¼Œæ²¡æœ‰è§¦å‘åº“å­˜æ‰£é™¤

**æ­£ç¡®æµç¨‹**ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç”¨æˆ·ä¸‹å•      â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è®¢å•æ’å…¥åˆ° orders è¡¨               â”‚
â”‚ status = 'pending'                â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ åå°ï¼šæ¥å—è®¢å•                     â”‚
â”‚ status = 'accepted'               â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ åå°ï¼šè®¢å•å®Œæˆ                     â”‚
â”‚ status = 'completed'              â”‚
â”‚ âš¡ï¸ è§¦å‘åº“å­˜æ‰£é™¤                   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è°ƒç”¨ RPC:                         â”‚
â”‚ consume_inventory_for_order(      â”‚
â”‚   order_id = 123                  â”‚
â”‚ )                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å‡½æ•°å†…éƒ¨é€»è¾‘ï¼š                     â”‚
â”‚ 1. è¯»å–è®¢å• items                  â”‚
â”‚ 2. è§£ææ¯ä¸ª item çš„åŸæ–™éœ€æ±‚         â”‚
â”‚ 3. è°ƒç”¨ deduct_inventory_fifo()   â”‚
â”‚    (FIFO æ‰£é™¤å„æ‰¹æ¬¡åº“å­˜)           â”‚
â”‚ 4. å†™å…¥ inventory_transactions    â”‚
â”‚ 5. æ›´æ–° qty_remaining             â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è¿”å›ç»“æœï¼š                         â”‚
â”‚ { success: true }                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ› ï¸ æŠ€æœ¯å®ç°æ–¹æ¡ˆ

### æ–¹æ¡ˆ Aï¼šå‰ç«¯æ˜¾å¼è°ƒç”¨ï¼ˆâœ… æ¨èï¼‰

**ä¼˜åŠ¿**ï¼š
- âœ… æ˜ç¡®æ§åˆ¶ï¼Œæ˜“äºè°ƒè¯•
- âœ… å¯ä»¥åœ¨ UI æ˜¾ç¤ºæ‰£åº“å­˜è¿›åº¦
- âœ… å¯ä»¥å¤„ç†åº“å­˜ä¸è¶³æƒ…å†µ

**å®ç°**ï¼š
```javascript
// admin.html - è®¢å•ç®¡ç†ç»„ä»¶
const handleCompleteOrder = async (orderId) => {
    // 1. æ›´æ–°è®¢å•çŠ¶æ€
    await updateOrderStatus(orderId, 'completed');

    // 2. æ‰£é™¤åº“å­˜
    const { data, error } = await supabaseClient
        .rpc('consume_inventory_for_order', {
            p_order_id: orderId
        });

    if (error || !data.success) {
        alert('âš ï¸ è®¢å•å·²å®Œæˆï¼Œä½†åº“å­˜æ‰£é™¤å¤±è´¥ï¼š' + error.message);
        // å¯ä»¥å›æ»šè®¢å•çŠ¶æ€
    }
};
```

### æ–¹æ¡ˆ Bï¼šæ•°æ®åº“è§¦å‘å™¨ï¼ˆâš ï¸ ä¸æ¨èï¼‰

**åŠ£åŠ¿**ï¼š
- âŒ éšå¼è¡Œä¸ºï¼Œéš¾ä»¥è°ƒè¯•
- âŒ è§¦å‘å™¨å¤±è´¥ä¸æ˜“å¯Ÿè§‰
- âŒ æ— æ³•åœ¨ UI æ˜¾ç¤ºè¿›åº¦

---

## âœ… æ€»ç»“ï¼šä¸‰å¤§åŸåˆ™

| åŸåˆ™ | å®æ–½æ–¹å¼ |
|------|---------|
| **Single Source of Truth** | qty_remaining åªèƒ½é€šè¿‡ RPC å‡½æ•°ä¿®æ”¹ |
| **å¼ºåˆ¶ Ledger è®°å½•** | æ¯æ¬¡å˜åŠ¨å¿…é¡»å†™å…¥ inventory_transactions |
| **è®¢å•-åº“å­˜é›†æˆ** | è®¢å• completed â†’ è°ƒç”¨ consume_inventory_for_order() |

---

## ğŸ“ ä¸‹ä¸€æ­¥å®æ–½

1. âœ… æ‰§è¡Œ `inventory-rls-policies.sql`ï¼ˆé”å®šç›´æ¥ä¿®æ”¹ï¼‰
2. âœ… åˆ›å»º `consume_inventory_for_order()` å‡½æ•°
3. âœ… ä¿®æ”¹å‰ç«¯è®¢å•å®Œæˆé€»è¾‘ï¼Œè°ƒç”¨åº“å­˜æ‰£é™¤
4. âœ… æµ‹è¯•å®Œæ•´æµç¨‹

---

**è¿™æ‰æ˜¯å®Œæ•´çš„åº“å­˜ç®¡ç†ç³»ç»Ÿè®¾è®¡ï¼** ğŸ¯
