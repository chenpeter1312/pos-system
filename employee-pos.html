<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Âì°Â∑• POS Á≥ªÁµ± - Lee's Taiwanese Comfort Food</title>

    <!-- Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase-config.js"></script>

    <!-- React & Babel -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Arial, sans-serif;
            background: #f5f5f5;
            overflow: hidden;
        }

        /* ==================== ÁôªÂÖ•ÁïåÈù¢ ==================== */
        .login-container {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .login-box {
            background: white;
            padding: 50px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            text-align: center;
            min-width: 400px;
        }

        .login-box h1 {
            font-size: 28px;
            margin-bottom: 10px;
            color: #333;
        }

        .login-box p {
            color: #666;
            margin-bottom: 30px;
        }

        .pin-input {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-bottom: 30px;
        }

        .pin-input input {
            width: 60px;
            height: 70px;
            font-size: 32px;
            text-align: center;
            border: 2px solid #ddd;
            border-radius: 10px;
            transition: all 0.3s;
        }

        .pin-input input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .error-message {
            color: #ef4444;
            margin-top: 15px;
            font-size: 14px;
        }

        /* ==================== POS ‰∏ªÁïåÈù¢ ==================== */
        .pos-container {
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* Â∑¶ÂÅ¥ - ÂàÜÈ°ûÈÅ∏Êìá */
        .sidebar {
            width: 200px;
            background: #1f2937;
            padding: 20px 10px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .sidebar-header {
            color: white;
            font-size: 18px;
            font-weight: bold;
            padding: 0 10px 15px;
            border-bottom: 1px solid #374151;
            margin-bottom: 10px;
        }

        .category-btn {
            padding: 15px;
            background: #374151;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: left;
        }

        .category-btn:hover {
            background: #4b5563;
        }

        .category-btn.active {
            background: #6B4423;
            font-weight: bold;
        }

        .logout-btn {
            margin-top: auto;
            padding: 15px;
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .logout-btn:hover {
            background: #dc2626;
        }

        /* ‰∏≠Èñì - ËèúÂñÆÈ†ÖÁõÆ */
        .menu-area {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: #f9fafb;
        }

        .menu-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .menu-header h2 {
            font-size: 24px;
            color: #111827;
        }

        .view-switch {
            display: flex;
            gap: 10px;
        }

        .view-btn {
            padding: 8px 16px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .view-btn.active {
            background: #6B4423;
            color: white;
            border-color: #6B4423;
        }

        .menu-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 15px;
        }

        .menu-item-card {
            background: white;
            border-radius: 12px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
            position: relative;
        }

        .menu-item-card:hover {
            border-color: #6B4423;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .menu-item-card.unavailable {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .menu-item-card.unavailable::after {
            content: 'Áº∫Ë≤®';
            position: absolute;
            top: 10px;
            right: 10px;
            background: #ef4444;
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 12px;
        }

        .menu-item-image {
            width: 100%;
            height: 120px;
            background: #f3f4f6;
            border-radius: 8px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 48px;
        }

        .menu-item-name {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 5px;
            color: #111827;
        }

        .menu-item-price {
            font-size: 18px;
            color: #6B4423;
            font-weight: bold;
        }

        /* Âè≥ÂÅ¥ - Ë≥ºÁâ©ËªäÂíåÁµêÂ∏≥ */
        .cart-panel {
            width: 400px;
            background: white;
            display: flex;
            flex-direction: column;
            border-left: 1px solid #e5e7eb;
        }

        .cart-header {
            padding: 20px;
            border-bottom: 1px solid #e5e7eb;
            background: #6B4423;
            color: white;
        }

        .cart-header h2 {
            font-size: 20px;
            margin-bottom: 5px;
        }

        .order-type-selector {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .order-type-btn {
            flex: 1;
            padding: 10px;
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 6px;
            color: white;
            cursor: pointer;
            transition: all 0.2s;
        }

        .order-type-btn.active {
            background: white;
            color: #6B4423;
            font-weight: bold;
        }

        .cart-items {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
        }

        .cart-item {
            display: flex;
            align-items: center;
            padding: 12px;
            background: #f9fafb;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .cart-item-details {
            flex: 1;
        }

        .cart-item-name {
            font-size: 15px;
            font-weight: 600;
            color: #111827;
            margin-bottom: 3px;
        }

        .cart-item-options {
            font-size: 13px;
            color: #6b7280;
        }

        .cart-item-price {
            font-size: 16px;
            font-weight: bold;
            color: #6B4423;
            margin-left: 10px;
        }

        .cart-item-qty {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-left: 10px;
        }

        .qty-btn {
            width: 28px;
            height: 28px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .qty-btn:hover {
            background: #f3f4f6;
        }

        .qty-display {
            font-size: 15px;
            font-weight: 600;
            min-width: 20px;
            text-align: center;
        }

        .cart-empty {
            text-align: center;
            padding: 60px 20px;
            color: #9ca3af;
        }

        .cart-empty-icon {
            font-size: 64px;
            margin-bottom: 15px;
        }

        .custom-item-btn {
            width: 100%;
            padding: 12px;
            background: #f3f4f6;
            border: 2px dashed #9ca3af;
            border-radius: 8px;
            color: #6b7280;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 10px;
        }

        .custom-item-btn:hover {
            background: #e5e7eb;
            border-color: #6b7280;
        }

        .cart-summary {
            padding: 20px;
            border-top: 2px solid #e5e7eb;
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
            font-size: 16px;
        }

        .summary-row.total {
            font-size: 24px;
            font-weight: bold;
            color: #6B4423;
            padding-top: 12px;
            border-top: 1px solid #e5e7eb;
        }

        .checkout-buttons {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 15px;
        }

        .payment-btn {
            padding: 16px;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            color: white;
        }

        .payment-btn.cash {
            background: #10b981;
        }

        .payment-btn.cash:hover {
            background: #059669;
        }

        .payment-btn.card {
            background: #3b82f6;
        }

        .payment-btn.card:hover {
            background: #2563eb;
        }

        .payment-btn.qr {
            background: #8b5cf6;
        }

        .payment-btn.qr:hover {
            background: #7c3aed;
        }

        .clear-cart-btn {
            width: 100%;
            padding: 12px;
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 8px;
            margin-top: 10px;
            cursor: pointer;
            font-size: 14px;
        }

        .clear-cart-btn:hover {
            background: #dc2626;
        }

        /* ==================== Modal ==================== */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            font-size: 22px;
            font-weight: bold;
            margin-bottom: 20px;
            color: #111827;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #374151;
        }

        .form-input {
            width: 100%;
            padding: 12px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 16px;
        }

        .form-input:focus {
            outline: none;
            border-color: #6B4423;
            box-shadow: 0 0 0 3px rgba(107, 68, 35, 0.1);
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 25px;
        }

        .btn {
            flex: 1;
            padding: 14px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: #6B4423;
            color: white;
        }

        .btn-primary:hover {
            background: #5a3a1e;
        }

        .btn-secondary {
            background: #f3f4f6;
            color: #374151;
        }

        .btn-secondary:hover {
            background: #e5e7eb;
        }

        /* ==================== Ë®ÇÂñÆÂàóË°®Ë¶ñÂúñ ==================== */
        .orders-list {
            padding: 20px;
        }

        .order-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            border: 2px solid #e5e7eb;
        }

        .order-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .order-number {
            font-size: 20px;
            font-weight: bold;
            color: #6B4423;
        }

        .order-status {
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
        }

        .order-status.pending {
            background: #fef3c7;
            color: #92400e;
        }

        .order-status.completed {
            background: #d1fae5;
            color: #065f46;
        }

        .order-items-summary {
            color: #6b7280;
            margin-bottom: 10px;
        }

        .order-card-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 15px;
            border-top: 1px solid #e5e7eb;
        }

        .order-total {
            font-size: 20px;
            font-weight: bold;
            color: #111827;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // Supabase ÂÆ¢Êà∂Á´ØÂàùÂßãÂåñ
        const supabaseClient = window.supabase.createClient(
            window.SUPABASE_CONFIG.url,
            window.SUPABASE_CONFIG.anonKey
        );
        window.supabaseClient = supabaseClient;

        // ==================== ‰∏ªÊáâÁî® ====================
        function App() {
            const [isLoggedIn, setIsLoggedIn] = useState(false);
            const [currentStaff, setCurrentStaff] = useState(null);
            const [sessionToken, setSessionToken] = useState(null); // ÂÆâÂÖ®Ôºösession token
            const [view, setView] = useState('menu'); // 'menu' or 'orders'

            // ËèúÂñÆÊï∏Êìö
            const [menuItems, setMenuItems] = useState([]);
            const [optionsLibrary, setOptionsLibrary] = useState([]);
            const [selectedCategory, setSelectedCategory] = useState('all');

            // Ë≥ºÁâ©Ëªä
            const [cart, setCart] = useState([]);
            const [orderType, setOrderType] = useState('dine_in');

            // Modal ÁãÄÊÖã
            const [showCustomItemModal, setShowCustomItemModal] = useState(false);
            const [customItemForm, setCustomItemForm] = useState({ name: '', amount: '' });

            // ËºâÂÖ•ËèúÂñÆÊï∏Êìö
            useEffect(() => {
                if (isLoggedIn) {
                    loadMenuData();
                }
            }, [isLoggedIn]);

            const loadMenuData = async () => {
                try {
                    const { data: menu, error: menuError } = await supabaseClient
                        .from('menu')
                        .select('*')
                        .eq('available', true)
                        .order('name');

                    const { data: options, error: optionsError } = await supabaseClient
                        .from('options_library')
                        .select('*')
                        .eq('is_enabled', true)
                        .order('name');

                    if (!menuError) setMenuItems(menu || []);
                    if (!optionsError) setOptionsLibrary(options || []);
                } catch (error) {
                    console.error('ËºâÂÖ•ËèúÂñÆÂ§±Êïó:', error);
                }
            };

            // ÁôªÂÖ•ËôïÁêÜ
            const handleLogin = (staffData, token) => {
                setCurrentStaff(staffData);
                setSessionToken(token);
                setIsLoggedIn(true);
            };

            // ÁôªÂá∫ËôïÁêÜ
            const handleLogout = async () => {
                if (confirm('Á¢∫ÂÆöË¶ÅÁôªÂá∫ÂóéÔºü')) {
                    // ÂÆâÂÖ®ÔºöÂëºÂè´ RPC ‰Ωø session Â§±Êïà
                    if (sessionToken) {
                        try {
                            await supabaseClient.rpc('staff_logout', {
                                p_session_token: sessionToken
                            });
                        } catch (error) {
                            console.error('ÁôªÂá∫ RPC ÈåØË™§:', error);
                        }
                    }

                    setIsLoggedIn(false);
                    setCurrentStaff(null);
                    setSessionToken(null);
                    setCart([]);
                }
            };

            // Ê∑ªÂä†ÂïÜÂìÅÂà∞Ë≥ºÁâ©Ëªä
            const addToCart = (item) => {
                const cartItem = {
                    id: Date.now(),
                    menuItemId: item.id,
                    name: item.name,
                    price: parseFloat(item.price),
                    quantity: 1,
                    options: [],
                    isCustom: false
                };
                setCart([...cart, cartItem]);
            };

            // Êõ¥Êñ∞Ë≥ºÁâ©ËªäÊï∏Èáè
            const updateCartItemQty = (cartItemId, change) => {
                setCart(cart.map(item => {
                    if (item.id === cartItemId) {
                        const newQty = item.quantity + change;
                        if (newQty <= 0) {
                            return null;
                        }
                        return { ...item, quantity: newQty };
                    }
                    return item;
                }).filter(item => item !== null));
            };

            // ÁßªÈô§Ë≥ºÁâ©ËªäÈ†ÖÁõÆ
            const removeFromCart = (cartItemId) => {
                setCart(cart.filter(item => item.id !== cartItemId));
            };

            // Ê∏ÖÁ©∫Ë≥ºÁâ©Ëªä
            const clearCart = () => {
                if (confirm('Á¢∫ÂÆöË¶ÅÊ∏ÖÁ©∫Ë≥ºÁâ©ËªäÂóéÔºü')) {
                    setCart([]);
                }
            };

            // Ê∑ªÂä†Ëá™ÂÆöÁæ©È†ÖÁõÆ
            const addCustomItem = () => {
                if (!customItemForm.name || !customItemForm.amount) {
                    alert('Ë´ãÂ°´ÂØ´ÂÆåÊï¥Ë≥áË®ä');
                    return;
                }

                const amount = parseFloat(customItemForm.amount);
                const cartItem = {
                    id: Date.now(),
                    menuItemId: null,
                    name: customItemForm.name,
                    price: amount,
                    quantity: 1,
                    options: [],
                    isCustom: true,
                    customAmount: amount
                };

                setCart([...cart, cartItem]);
                setShowCustomItemModal(false);
                setCustomItemForm({ name: '', amount: '' });
            };

            // ÁµêÂ∏≥ËôïÁêÜÔºàÂÆâÂÖ®Ôºö‰ΩøÁî® RPCÔºâ
            const handleCheckout = async (paymentMethod) => {
                if (cart.length === 0) {
                    alert('Ë≥ºÁâ©ËªäÊòØÁ©∫ÁöÑÔºÅ');
                    return;
                }

                if (!sessionToken) {
                    alert('‚ùå Session Â∑≤ÈÅéÊúüÔºåË´ãÈáçÊñ∞ÁôªÂÖ•');
                    setIsLoggedIn(false);
                    return;
                }

                // Ë®àÁÆóÁ∏ΩÈáëÈ°ç
                const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
                const tax = subtotal * 0.0825; // Texas 8.25% Á®ÖÁéá
                const total = subtotal + tax;

                // Ê∫ñÂÇôÂïÜÂìÅÂàóË°®ÔºàRPC ÈúÄË¶ÅÁöÑÊ†ºÂºèÔºâ
                const itemsForRPC = cart.map(item => ({
                    item_id: item.menuItemId,
                    name: item.name,
                    quantity: item.quantity,
                    price: item.price,
                    options: item.options || [],
                    is_custom: item.isCustom || false
                }));

                try {
                    // ÂÆâÂÖ®ÔºöÈÄèÈÅé RPC ÂâµÂª∫Ë®ÇÂñÆÔºàÊúâ transaction ‰øùË≠∑ + ÂØ©Ë®àÊó•Ë™åÔºâ
                    const { data, error } = await supabaseClient.rpc('create_staff_order', {
                        p_session_token: sessionToken,
                        p_customer_name: 'ÁèæÂ†¥È°ßÂÆ¢',
                        p_phone: '',
                        p_order_type: orderType,
                        p_items: itemsForRPC,
                        p_subtotal: subtotal,
                        p_tax: tax,
                        p_tip: 0,
                        p_total: total,
                        p_payment_method: paymentMethod,
                        p_notes: `POS Ë®ÇÂñÆÔºåÁî± ${currentStaff.display_name || currentStaff.username} Âª∫Á´ã`
                    });

                    if (error) {
                        console.error('‚ùå Âª∫ÂñÆ RPC ÈåØË™§:', error);
                        throw error;
                    }

                    if (!data || data.length === 0) {
                        throw new Error('RPC Ê≤íÊúâËøîÂõûÁµêÊûú');
                    }

                    const result = data[0];

                    if (!result.success) {
                        // Session ÈÅéÊúüÊàñÂÖ∂‰ªñÈåØË™§
                        if (result.message.includes('Session') || result.message.includes('ÈÅéÊúü')) {
                            alert('‚ùå ' + result.message);
                            setIsLoggedIn(false);
                            setSessionToken(null);
                            return;
                        }
                        throw new Error(result.message);
                    }

                    // ÊàêÂäü
                    const orderNumber = result.order_id;
                    const paymentMethodText = {
                        'cash': 'üíµ ÁèæÈáë',
                        'card': 'üí≥ Âà∑Âç°',
                        'stripe': 'üí≥ Stripe',
                        'other': 'üì± ÂÖ∂‰ªñ'
                    }[paymentMethod] || paymentMethod;

                    alert(`‚úÖ Ë®ÇÂñÆÂ∑≤ÂÆåÊàêÔºÅ\nË®ÇÂñÆÁ∑®ËôüÔºö${orderNumber}\nÁ∏ΩÈáëÈ°çÔºö$${total.toFixed(2)}\n‰ªòÊ¨æÊñπÂºèÔºö${paymentMethodText}`);
                    setCart([]);

                    // Âà∑Êñ∞Ë®ÇÂñÆÂàóË°®ÔºàÂ¶ÇÊûúÂú®Ë®ÇÂñÆÈ†ÅÈù¢Ôºâ
                    if (view === 'orders') {
                        setTimeout(() => window.location.reload(), 1000);
                    }
                } catch (error) {
                    console.error('ÁµêÂ∏≥Â§±Êïó:', error);
                    alert('ÁµêÂ∏≥Â§±ÊïóÔºö' + error.message);
                }
            };

            // Êâ£Èô§Â∫´Â≠ò
            const deductInventory = async (cartItems) => {
                console.log('üîÑ ÈñãÂßãÊâ£Èô§Â∫´Â≠ò...');

                try {
                    for (const item of cartItems) {
                        if (item.isCustom) {
                            console.log(`‚è≠Ô∏è Ë∑≥ÈÅéËá™ÂÆöÁæ©È†ÖÁõÆ: ${item.name}`);
                            continue; // Ëá™ÂÆöÁæ©È†ÖÁõÆ‰∏çÊâ£Â∫´Â≠ò
                        }

                        // Êü•Ë©¢Ë©≤ËèúÂìÅÁöÑÂåÖÊùêÈÖçÁΩÆ
                        const { data: packagingMap, error: mapError } = await supabaseClient
                            .from('menu_packaging_map')
                            .select('inventory_item_id, qty_per_sale')
                            .eq('menu_item_name', item.name);

                        if (mapError) {
                            console.error(`‚ùå Êü•Ë©¢ÂåÖÊùêÈÖçÁΩÆÂ§±Êïó (${item.name}):`, mapError);
                            continue;
                        }

                        if (!packagingMap || packagingMap.length === 0) {
                            console.log(`‚ö†Ô∏è ${item.name} Ê≤íÊúâÈÖçÁΩÆÂåÖÊùê`);
                            continue;
                        }

                        // Êâ£Èô§ÊØèÂÄãÂåÖÊùêÁöÑÂ∫´Â≠ò
                        for (const mapping of packagingMap) {
                            const deductQty = mapping.qty_per_sale * item.quantity;

                            const { error: updateError } = await supabaseClient.rpc(
                                'decrement_inventory',
                                {
                                    item_id: mapping.inventory_item_id,
                                    quantity: deductQty
                                }
                            );

                            if (updateError) {
                                console.error(`‚ùå Êâ£Èô§Â∫´Â≠òÂ§±Êïó:`, updateError);
                                // ÁπºÁ∫åËôïÁêÜÂÖ∂‰ªñÈ†ÖÁõÆÔºå‰∏ç‰∏≠Êñ∑
                            } else {
                                console.log(`‚úÖ Â∑≤Êâ£Èô§Â∫´Â≠ò (ID: ${mapping.inventory_item_id}, Êï∏Èáè: ${deductQty})`);
                            }
                        }
                    }

                    console.log('‚úÖ Â∫´Â≠òÊâ£Èô§ÂÆåÊàê');
                } catch (error) {
                    console.error('‚ùå Â∫´Â≠òÊâ£Èô§ÈÅéÁ®ãÂá∫ÈåØ:', error);
                    // ‰∏çÊããÂá∫ÈåØË™§ÔºåÂõ†ÁÇ∫Ë®ÇÂñÆÂ∑≤Á∂ìÂâµÂª∫‰∫Ü
                }
            };

            // Ë®àÁÆóË≥ºÁâ©ËªäÁµ±Ë®à
            const cartStats = {
                itemCount: cart.reduce((sum, item) => sum + item.quantity, 0),
                subtotal: cart.reduce((sum, item) => sum + (item.price * item.quantity), 0),
                tax: cart.reduce((sum, item) => sum + (item.price * item.quantity), 0) * 0.0825,
                get total() { return this.subtotal + this.tax; }
            };

            if (!isLoggedIn) {
                return <LoginScreen onLogin={handleLogin} />;
            }

            return (
                <div className="pos-container">
                    {/* Â∑¶ÂÅ¥ÈÇäÊ¨Ñ */}
                    <div className="sidebar">
                        <div className="sidebar-header">
                            {currentStaff.display_name}
                        </div>

                        <button
                            className={`category-btn ${view === 'menu' ? 'active' : ''}`}
                            onClick={() => setView('menu')}
                        >
                            üìã ÈªûÈ§ê
                        </button>

                        <button
                            className={`category-btn ${view === 'orders' ? 'active' : ''}`}
                            onClick={() => setView('orders')}
                        >
                            üìä Ë®ÇÂñÆ
                        </button>

                        <button className="logout-btn" onClick={handleLogout}>
                            ÁôªÂá∫
                        </button>
                    </div>

                    {/* ‰∏≠ÈñìËèúÂñÆÂçÄ */}
                    {view === 'menu' && (
                        <div className="menu-area">
                            <div className="menu-header">
                                <h2>ËèúÂñÆ</h2>
                            </div>

                            <div className="menu-grid">
                                {menuItems.map(item => (
                                    <div
                                        key={item.id}
                                        className={`menu-item-card ${!item.available ? 'unavailable' : ''}`}
                                        onClick={() => item.available && addToCart(item)}
                                    >
                                        <div className="menu-item-image">
                                            {item.emoji || 'üçΩÔ∏è'}
                                        </div>
                                        <div className="menu-item-name">{item.name}</div>
                                        <div className="menu-item-price">${parseFloat(item.price).toFixed(2)}</div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}

                    {view === 'orders' && (
                        <div className="menu-area">
                            <div className="menu-header">
                                <h2>‰ªäÊó•Ë®ÇÂñÆ</h2>
                            </div>
                            <OrdersList />
                        </div>
                    )}

                    {/* Âè≥ÂÅ¥Ë≥ºÁâ©Ëªä */}
                    <div className="cart-panel">
                        <div className="cart-header">
                            <h2>Ë≥ºÁâ©Ëªä ({cartStats.itemCount})</h2>

                            <div className="order-type-selector">
                                <button
                                    className={`order-type-btn ${orderType === 'dine_in' ? 'active' : ''}`}
                                    onClick={() => setOrderType('dine_in')}
                                >
                                    ÂÖßÁî®
                                </button>
                                <button
                                    className={`order-type-btn ${orderType === 'takeout' ? 'active' : ''}`}
                                    onClick={() => setOrderType('takeout')}
                                >
                                    Â§ñÂ∏∂
                                </button>
                            </div>
                        </div>

                        <div className="cart-items">
                            {cart.length === 0 ? (
                                <div className="cart-empty">
                                    <div className="cart-empty-icon">üõí</div>
                                    <div>Ë≥ºÁâ©ËªäÊòØÁ©∫ÁöÑ</div>
                                </div>
                            ) : (
                                <>
                                    {cart.map(item => (
                                        <div key={item.id} className="cart-item">
                                            <div className="cart-item-details">
                                                <div className="cart-item-name">
                                                    {item.name}
                                                    {item.isCustom && <span style={{color: '#6b7280', fontSize: '12px'}}> (Ëá™Ë®Ç)</span>}
                                                </div>
                                                <div className="cart-item-price">
                                                    ${(item.price * item.quantity).toFixed(2)}
                                                </div>
                                            </div>
                                            <div className="cart-item-qty">
                                                <button className="qty-btn" onClick={() => updateCartItemQty(item.id, -1)}>‚àí</button>
                                                <span className="qty-display">{item.quantity}</span>
                                                <button className="qty-btn" onClick={() => updateCartItemQty(item.id, 1)}>+</button>
                                            </div>
                                        </div>
                                    ))}

                                    <button className="custom-item-btn" onClick={() => setShowCustomItemModal(true)}>
                                        ‚ûï Âä†Ëá™Ë®ÇÈ†ÖÁõÆ
                                    </button>
                                </>
                            )}
                        </div>

                        <div className="cart-summary">
                            <div className="summary-row">
                                <span>Â∞èË®à</span>
                                <span>${cartStats.subtotal.toFixed(2)}</span>
                            </div>
                            <div className="summary-row">
                                <span>Á®ÖÈáë (8.25%)</span>
                                <span>${cartStats.tax.toFixed(2)}</span>
                            </div>
                            <div className="summary-row total">
                                <span>Á∏ΩË®à</span>
                                <span>${cartStats.total.toFixed(2)}</span>
                            </div>

                            <div className="checkout-buttons">
                                <button
                                    className="payment-btn cash"
                                    onClick={() => handleCheckout('cash')}
                                    disabled={cart.length === 0}
                                >
                                    üíµ ÁèæÈáë
                                </button>
                                <button
                                    className="payment-btn card"
                                    onClick={() => handleCheckout('card')}
                                    disabled={cart.length === 0}
                                >
                                    üí≥ Âà∑Âç°
                                </button>
                                <button
                                    className="payment-btn qr"
                                    onClick={() => handleCheckout('other')}
                                    disabled={cart.length === 0}
                                >
                                    üì± ÂÖ∂‰ªñ
                                </button>
                            </div>

                            {cart.length > 0 && (
                                <button className="clear-cart-btn" onClick={clearCart}>
                                    Ê∏ÖÁ©∫Ë≥ºÁâ©Ëªä
                                </button>
                            )}
                        </div>
                    </div>

                    {/* Ëá™Ë®ÇÈ†ÖÁõÆ Modal */}
                    <div className={`modal ${showCustomItemModal ? 'show' : ''}`}>
                        <div className="modal-content">
                            <div className="modal-header">Âä†Ëá™Ë®ÇÈ†ÖÁõÆ</div>

                            <div className="form-group">
                                <label className="form-label">È†ÖÁõÆÂêçÁ®±</label>
                                <input
                                    type="text"
                                    className="form-input"
                                    placeholder="‰æãÂ¶ÇÔºöÊäòÊâ£„ÄÅÂä†Êñô„ÄÅÊúçÂãôË≤ª"
                                    value={customItemForm.name}
                                    onChange={(e) => setCustomItemForm({...customItemForm, name: e.target.value})}
                                />
                            </div>

                            <div className="form-group">
                                <label className="form-label">ÈáëÈ°çÔºàÂèØÁÇ∫Ë≤†Êï∏Ôºâ</label>
                                <input
                                    type="number"
                                    step="0.01"
                                    className="form-input"
                                    placeholder="‰æãÂ¶ÇÔºö10 Êàñ -5"
                                    value={customItemForm.amount}
                                    onChange={(e) => setCustomItemForm({...customItemForm, amount: e.target.value})}
                                />
                            </div>

                            <div className="modal-buttons">
                                <button className="btn btn-secondary" onClick={() => setShowCustomItemModal(false)}>
                                    ÂèñÊ∂à
                                </button>
                                <button className="btn btn-primary" onClick={addCustomItem}>
                                    Á¢∫ÂÆö
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        // ==================== ÁôªÂÖ•ÁïåÈù¢ ====================
        function LoginScreen({ onLogin }) {
            const [pin, setPin] = useState(['', '', '', '']);
            const [error, setError] = useState('');
            const inputRefs = [
                React.useRef(null),
                React.useRef(null),
                React.useRef(null),
                React.useRef(null)
            ];

            const handlePinChange = (index, value) => {
                if (!/^\d*$/.test(value)) return;

                const newPin = [...pin];
                newPin[index] = value;
                setPin(newPin);
                setError('');

                if (value && index < 3) {
                    inputRefs[index + 1].current.focus();
                }

                if (newPin.every(digit => digit !== '') && index === 3) {
                    verifyPin(newPin.join(''));
                }
            };

            const handleKeyDown = (index, e) => {
                if (e.key === 'Backspace' && !pin[index] && index > 0) {
                    inputRefs[index - 1].current.focus();
                }
            };

            const verifyPin = async (pinCode) => {
                try {
                    // ÂÆâÂÖ®Ôºö‰ΩøÁî® RPC ÁôªÂÖ•ÔºàÊúâ rate limiting + ÂØ©Ë®àÊó•Ë™åÔºâ
                    // Ë®ªÔºö‰∏çÁõ¥Êé•Êü•Ë©¢ staff_users Ë°®ÔºåÈÅøÂÖçÊö¥ÂäõÁ†¥Ëß£
                    const { data, error } = await window.supabaseClient.rpc('attempt_staff_login', {
                        p_username: pinCode, // Á∞°ÂåñÁâàÔºöPIN Âç≥ usernameÔºà‰Ω†‰πüÂèØÊîπÊàêË¶ÅÂÖàËº∏ÂÖ• usernameÔºâ
                        p_pin_code: pinCode,
                        p_ip_address: 'pos_device', // ÂØ¶ÈöõÂèØÁî® device ID Êàñ IP
                        p_device_info: navigator.userAgent
                    });

                    if (error) {
                        console.error('‚ùå ÁôªÂÖ• RPC ÈåØË™§:', error);
                        setError('‚ùå ÁôªÂÖ•Â§±ÊïóÔºåË´ãÁ®çÂæåÂÜçË©¶');
                        setPin(['', '', '', '']);
                        inputRefs[0].current.focus();
                        return;
                    }

                    if (!data || data.length === 0) {
                        setError('‚ùå ÁôªÂÖ•Â§±Êïó');
                        setPin(['', '', '', '']);
                        inputRefs[0].current.focus();
                        return;
                    }

                    const result = data[0];

                    if (!result.success) {
                        // È°ØÁ§∫ÂÖ∑È´îÈåØË™§Ë®äÊÅØÔºàÂåÖÂê´Ââ©È§òÊ¨°Êï∏ÊàñÈéñÂÆöÊôÇÈñìÔºâ
                        setError(result.message);
                        setPin(['', '', '', '']);
                        inputRefs[0].current.focus();
                        return;
                    }

                    // ÁôªÂÖ•ÊàêÂäüÔºåÂÇ≥ÈÅû staff Ë≥áË®äÂíå session token
                    const staffData = {
                        id: result.staff_id,
                        username: result.staff_name,
                        display_name: result.staff_name,
                        role: result.staff_role
                    };

                    onLogin(staffData, result.session_token);

                } catch (err) {
                    console.error('‚ùå ÁôªÂÖ•Áï∞Â∏∏:', err);
                    setError('‚ùå ÁôªÂÖ•Â§±Êïó');
                    setPin(['', '', '', '']);
                    inputRefs[0].current.focus();
                }
            };

            useEffect(() => {
                inputRefs[0].current.focus();
            }, []);

            return (
                <div className="login-container">
                    <div className="login-box">
                        <h1>üîê Âì°Â∑•ÁôªÂÖ•</h1>
                        <p>Ë´ãËº∏ÂÖ•ÊÇ®ÁöÑ 4 ‰ΩçÊï∏ PIN Á¢º</p>

                        <div className="pin-input">
                            {pin.map((digit, index) => (
                                <input
                                    key={index}
                                    ref={inputRefs[index]}
                                    type="password"
                                    maxLength="1"
                                    value={digit}
                                    onChange={(e) => handlePinChange(index, e.target.value)}
                                    onKeyDown={(e) => handleKeyDown(index, e)}
                                />
                            ))}
                        </div>

                        {error && <div className="error-message">{error}</div>}

                        <div style={{marginTop: '30px', fontSize: '13px', color: '#9ca3af'}}>
                            Ê∏¨Ë©¶Ë≥¨ËôüÔºö1111 (Âì°Â∑•) / 1234 (ÁÆ°ÁêÜÂì°)
                        </div>
                    </div>
                </div>
            );
        }

        // ==================== Ë®ÇÂñÆÂàóË°® ====================
        function OrdersList() {
            const [orders, setOrders] = useState([]);

            useEffect(() => {
                loadOrders();
            }, []);

            const loadOrders = async () => {
                try {
                    const { data, error } = await window.supabaseClient
                        .from('orders')
                        .select('*')
                        .eq('order_source', 'staff_pos')
                        .gte('created_at', new Date().toISOString().split('T')[0])
                        .order('created_at', { ascending: false });

                    if (!error) {
                        setOrders(data || []);
                    }
                } catch (error) {
                    console.error('ËºâÂÖ•Ë®ÇÂñÆÂ§±Êïó:', error);
                }
            };

            return (
                <div className="orders-list">
                    {orders.length === 0 ? (
                        <div style={{textAlign: 'center', padding: '60px', color: '#9ca3af'}}>
                            <div style={{fontSize: '64px', marginBottom: '15px'}}>üì≠</div>
                            <div>‰ªäÊó•Â∞öÁÑ°Ë®ÇÂñÆ</div>
                        </div>
                    ) : (
                        orders.map(order => (
                            <div key={order.id} className="order-card">
                                <div className="order-card-header">
                                    <div className="order-number">
                                        #{order.daily_order_number || order.id}
                                    </div>
                                    <div className={`order-status ${order.status}`}>
                                        {order.status === 'accepted' ? 'Ë£Ω‰Ωú‰∏≠' : order.status === 'completed' ? 'Â∑≤ÂÆåÊàê' : 'ÂæÖËôïÁêÜ'}
                                    </div>
                                </div>

                                <div className="order-items-summary">
                                    {order.items && order.items.length > 0
                                        ? order.items.map(item => item.name).join(', ')
                                        : 'ÁÑ°ÂìÅÈ†Ö'}
                                </div>

                                <div className="order-card-footer">
                                    <div style={{color: '#6b7280', fontSize: '14px'}}>
                                        {order.order_type === 'dine_in' ? 'ÂÖßÁî®' : 'Â§ñÂ∏∂'} ¬∑ {order.payment_method === 'cash' ? 'ÁèæÈáë' : order.payment_method === 'card' ? 'Âà∑Âç°' : 'ÊéÉÁ¢º'}
                                    </div>
                                    <div className="order-total">
                                        ${parseFloat(order.total_price).toFixed(2)}
                                    </div>
                                </div>
                            </div>
                        ))
                    )}
                </div>
            );
        }

        // ==================== Ê∏≤ÊüìÊáâÁî® ====================
        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
