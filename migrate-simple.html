<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®€å•ç‰ˆæ•°æ®è¿ç§»</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: Arial, sans-serif;
            padding: 40px;
            background: #f5f5f5;
            line-height: 1.6;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 { color: #333; margin-bottom: 20px; }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 16px;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px 10px 10px 0;
        }
        button:hover { background: #45a049; }
        button:active { transform: scale(0.98); }
        button.danger { background: #f44336; }
        button.danger:hover { background: #da190b; }
        #output {
            margin-top: 20px;
            padding: 20px;
            background: #1e1e1e;
            color: #00ff00;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            min-height: 300px;
            max-height: 500px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .info {
            background: #e3f2fd;
            padding: 15px;
            border-left: 4px solid #2196F3;
            margin: 15px 0;
        }
        .success { background: #e8f5e9; border-left-color: #4CAF50; }
        .error { background: #ffebee; border-left-color: #f44336; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸš€ ç®€å•ç‰ˆæ•°æ®è¿ç§»å·¥å…·</h1>

        <div class="info">
            <strong>ğŸ“Š å½“å‰ localStorage æ•°æ®ï¼š</strong><br>
            <span id="local-stats">åŠ è½½ä¸­...</span>
        </div>

        <div>
            <button onclick="testConnection()" id="test-btn">
                1ï¸âƒ£ æµ‹è¯•è¿æ¥
            </button>
            <button onclick="migrateAll()" id="migrate-btn">
                2ï¸âƒ£ ä¸€é”®è¿ç§»å…¨éƒ¨æ•°æ®
            </button>
            <button onclick="clearOutput()" style="background: #666;">
                æ¸…ç©ºæ—¥å¿—
            </button>
        </div>

        <div id="output">ç­‰å¾…æ“ä½œ...</div>
    </div>

    <script>
        // ğŸ”¥ è¯Šæ–­ï¼šJS æ˜¯å¦æ‰§è¡Œ
        console.log('ğŸ”¥ SCRIPT STARTED - JS IS RUNNING');
        alert('ğŸ”¥ JS æ‰§è¡Œæµ‹è¯•ï¼šå¦‚æœçœ‹åˆ°è¿™ä¸ªå¼¹çª—ï¼Œè¯´æ˜ JS èƒ½è¿è¡Œï¼');

        // Supabase é…ç½®
        const SUPABASE_URL = 'https://tskelejztsdeewtpjcoq.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRza2VsZWp6dHNkZWV3dHBqY29xIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzExOTUxNjUsImV4cCI6MjA4Njc3MTE2NX0.WFGyeBVRIXfrA9h2BVwQ9zpbmcHDXmI0xsFfdDVdGos';

        console.log('âœ… Constants defined');

        let supabase = null;
        const output = document.getElementById('output');
        console.log('âœ… Got output element:', output);

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const colors = {
                info: '#00ff00',
                success: '#00ff00',
                error: '#ff0000',
                warning: '#ffff00'
            };
            output.innerHTML += `<span style="color: ${colors[type]}">[${timestamp}] ${message}</span>\n`;
            output.scrollTop = output.scrollHeight;
            console.log(`[${type}] ${message}`);
        }

        function clearOutput() {
            output.innerHTML = '';
            log('æ—¥å¿—å·²æ¸…ç©º');
        }

        // é¡µé¢åŠ è½½æ—¶æ˜¾ç¤ºæœ¬åœ°æ•°æ®
        window.addEventListener('DOMContentLoaded', function() {
            log('=== é¡µé¢åŠ è½½å®Œæˆ ===');

            try {
                const menu = JSON.parse(localStorage.getItem('menu') || '[]');
                const options = JSON.parse(localStorage.getItem('optionsLibrary') || '[]');
                const orders = JSON.parse(localStorage.getItem('orders') || '[]');

                document.getElementById('local-stats').innerHTML = `
                    ğŸ± èœå•: <strong>${menu.length}</strong> ä¸ª |
                    âš™ï¸ é€‰é¡¹: <strong>${options.length}</strong> ä¸ª |
                    ğŸ“¦ è®¢å•: <strong>${orders.length}</strong> ä¸ª
                `;

                log(`è¯»å– localStorage: èœå• ${menu.length} ä¸ª, é€‰é¡¹ ${options.length} ä¸ª, è®¢å• ${orders.length} ä¸ª`);
            } catch (e) {
                log('è¯»å– localStorage å¤±è´¥: ' + e.message, 'error');
            }

            // åˆå§‹åŒ– Supabase
            try {
                log('åˆå§‹åŒ– Supabase å®¢æˆ·ç«¯...');
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                log('âœ… Supabase å®¢æˆ·ç«¯åˆå§‹åŒ–æˆåŠŸ', 'success');
            } catch (e) {
                log('âŒ Supabase åˆå§‹åŒ–å¤±è´¥: ' + e.message, 'error');
            }
        });

        async function testConnection() {
            log('\n=== å¼€å§‹æµ‹è¯•è¿æ¥ ===');
            const btn = document.getElementById('test-btn');
            btn.disabled = true;
            btn.textContent = 'æµ‹è¯•ä¸­...';

            try {
                if (!supabase) {
                    throw new Error('Supabase å®¢æˆ·ç«¯æœªåˆå§‹åŒ–');
                }

                log('æŸ¥è¯¢ menu è¡¨...');
                const { data, error, count } = await supabase
                    .from('menu')
                    .select('*', { count: 'exact', head: true });

                if (error) {
                    throw error;
                }

                log('âœ… è¿æ¥æˆåŠŸï¼', 'success');
                log(`menu è¡¨å½“å‰æœ‰ ${count || 0} æ¡è®°å½•`);

                // æµ‹è¯•å…¶ä»–è¡¨
                const { count: optCount } = await supabase.from('options_library').select('*', { count: 'exact', head: true });
                const { count: ordCount } = await supabase.from('orders').select('*', { count: 'exact', head: true });

                log(`options_library è¡¨å½“å‰æœ‰ ${optCount || 0} æ¡è®°å½•`);
                log(`orders è¡¨å½“å‰æœ‰ ${ordCount || 0} æ¡è®°å½•`);
                log('=== æµ‹è¯•å®Œæˆ ===\n', 'success');

            } catch (e) {
                log('âŒ è¿æ¥å¤±è´¥: ' + e.message, 'error');
                log('è¯·æ£€æŸ¥ï¼š1. æ•°æ®åº“è¡¨æ˜¯å¦åˆ›å»º 2. RLS ç­–ç•¥æ˜¯å¦è®¾ç½®', 'warning');
            } finally {
                btn.disabled = false;
                btn.textContent = '1ï¸âƒ£ æµ‹è¯•è¿æ¥';
            }
        }

        async function migrateAll() {
            if (!confirm('ç¡®å®šè¦å¼€å§‹è¿ç§»æ‰€æœ‰æ•°æ®å—ï¼Ÿ')) return;

            log('\n=== å¼€å§‹è¿ç§»æ•°æ® ===');
            const btn = document.getElementById('migrate-btn');
            btn.disabled = true;
            btn.textContent = 'è¿ç§»ä¸­...';

            try {
                if (!supabase) {
                    throw new Error('Supabase å®¢æˆ·ç«¯æœªåˆå§‹åŒ–');
                }

                // 1. è¿ç§»é€‰é¡¹åº“
                log('\n[1/3] è¿ç§»é€‰é¡¹åº“...');
                const optionsLibrary = JSON.parse(localStorage.getItem('optionsLibrary') || '[]');

                if (optionsLibrary.length > 0) {
                    log(`å‡†å¤‡è¿ç§» ${optionsLibrary.length} ä¸ªé€‰é¡¹...`);

                    const optionsData = optionsLibrary.map(opt => ({
                        id: opt.id,
                        name: opt.name,
                        type: opt.type,
                        required: opt.required,
                        is_enabled: opt.isEnabled !== false,
                        categories: opt.categories || [],
                        choices: opt.choices
                    }));

                    const { error: optError } = await supabase
                        .from('options_library')
                        .upsert(optionsData);

                    if (optError) throw new Error('é€‰é¡¹åº“è¿ç§»å¤±è´¥: ' + optError.message);
                    log(`âœ… é€‰é¡¹åº“è¿ç§»æˆåŠŸ: ${optionsLibrary.length} ä¸ª`, 'success');
                } else {
                    log('âš ï¸ æ²¡æœ‰é€‰é¡¹åº“æ•°æ®', 'warning');
                }

                // 2. è¿ç§»èœå•
                log('\n[2/3] è¿ç§»èœå•...');
                const menu = JSON.parse(localStorage.getItem('menu') || '[]');

                if (menu.length > 0) {
                    log(`å‡†å¤‡è¿ç§» ${menu.length} ä¸ªèœå•é¡¹...`);

                    const menuData = menu.map(item => ({
                        id: item.id,
                        name: item.name,
                        english_name: item.englishName,
                        price: item.price,
                        category: item.category,
                        emoji: item.emoji,
                        image: item.image,
                        description: item.description,
                        available: item.available !== false,
                        applied_option_ids: item.appliedOptionIds || []
                    }));

                    const { error: menuError } = await supabase
                        .from('menu')
                        .upsert(menuData);

                    if (menuError) throw new Error('èœå•è¿ç§»å¤±è´¥: ' + menuError.message);
                    log(`âœ… èœå•è¿ç§»æˆåŠŸ: ${menu.length} ä¸ª`, 'success');
                } else {
                    log('âš ï¸ æ²¡æœ‰èœå•æ•°æ®', 'warning');
                }

                // 3. è¿ç§»è®¢å•
                log('\n[3/3] è¿ç§»è®¢å•...');
                const orders = JSON.parse(localStorage.getItem('orders') || '[]');

                if (orders.length > 0) {
                    log(`å‡†å¤‡è¿ç§» ${orders.length} ä¸ªè®¢å•...`);

                    const ordersData = orders.map(order => ({
                        id: order.id,
                        customer_name: order.customerName,
                        phone: order.phone,
                        service_mode: order.serviceMode,
                        items: order.items,
                        total: order.total,
                        status: order.status || 'pending',
                        notes: order.notes,
                        scheduled_time: order.scheduledTime,
                        created_at: order.timestamp
                    }));

                    const { error: ordError } = await supabase
                        .from('orders')
                        .upsert(ordersData);

                    if (ordError) throw new Error('è®¢å•è¿ç§»å¤±è´¥: ' + ordError.message);
                    log(`âœ… è®¢å•è¿ç§»æˆåŠŸ: ${orders.length} ä¸ª`, 'success');
                } else {
                    log('âš ï¸ æ²¡æœ‰è®¢å•æ•°æ®', 'warning');
                }

                log('\nğŸ‰ğŸ‰ğŸ‰ æ‰€æœ‰æ•°æ®è¿ç§»å®Œæˆï¼ğŸ‰ğŸ‰ğŸ‰', 'success');
                log('ç°åœ¨å¯ä»¥åœ¨ Supabase Table Editor ä¸­æŸ¥çœ‹æ•°æ®äº†');

            } catch (e) {
                log('\nâŒ è¿ç§»å¤±è´¥: ' + e.message, 'error');
                log('é”™è¯¯è¯¦æƒ…: ' + JSON.stringify(e), 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = '2ï¸âƒ£ ä¸€é”®è¿ç§»å…¨éƒ¨æ•°æ®';
            }
        }
    </script>
</body>
</html>
