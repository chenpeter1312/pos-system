# ğŸ”’ POS ç³»çµ±å®‰å…¨ä¿®å¾©ç¸½çµ

**ä¿®å¾©æ—¥æœŸï¼š** 2026-02-20
**ä¿®å¾©äººå“¡ï¼š** Claude Sonnet 4.5 + Peter Chen
**ä¿®å¾©ç¯„åœï¼š** 5 å€‹æ ¸å¿ƒå®‰å…¨æ¼æ´

---

## âœ… å·²å®Œæˆçš„ä¿®å¾©

### 1ï¸âƒ£ **å®¢äººç«¯ anon key æ¼æ´ä¿®å¾©** âš ï¸ é«˜é¢¨éšª

**å•é¡Œï¼š**
- å®¢äººé»é¤ç³»çµ±ä½¿ç”¨ `anon key` ç›´æ¥ `INSERT` åˆ° `orders` å’Œ `order_items` è¡¨
- å¯è¢«æƒ¡æ„ç”¨æˆ¶å¤§é‡å»ºç«‹å‡è¨‚å–®ï¼ˆDDoS æ”»æ“Šï¼‰
- å‰ç«¯å‚³ä¾†çš„åƒ¹æ ¼æœªç¶“é©—è­‰ï¼Œå¯è¢«ç«„æ”¹

**ä¿®å¾©æ–¹æ¡ˆï¼š**
- âœ… å»ºç«‹ `create_public_order()` RPC å‡½æ•¸
- âœ… Rate Limitingï¼šæ¯ IP æ¯åˆ†é˜æœ€å¤š 10 ç­†è¨‚å–®
- âœ… åƒ¹æ ¼é‡æ–°è¨ˆç®—ï¼šåªä¿¡ä»» `item_id` + `quantity`ï¼Œå¾è³‡æ–™åº«æŸ¥è©¢çœŸå¯¦åƒ¹æ ¼
- âœ… æ•¸é‡é©—è­‰ï¼šé™åˆ¶ 1-99 å€‹ï¼ˆé˜²æ­¢æƒ¡æ„å¤§é‡ä¸‹å–®ï¼‰
- âœ… åŸå­æ€§æ“ä½œï¼šä½¿ç”¨ Transaction

**å½±éŸ¿ç¯„åœï¼š**
- `pos.html` éœ€è¦æ”¹ç”¨æ–°çš„ RPCï¼ˆå‰ç«¯å°šæœªæ›´æ–°ï¼‰

---

### 2ï¸âƒ£ **Admin å¾Œå°ç„¡ä¿è­·æ¼æ´ä¿®å¾©** ğŸš¨ æ¥µé«˜é¢¨éšª

**å•é¡Œï¼š**
- `admin.html` ä½¿ç”¨ `anon key`ï¼Œä»»ä½•äººéƒ½èƒ½è¨ªå•
- æ²’æœ‰æ¬Šé™æ§åˆ¶ï¼Œä»»ä½•äººéƒ½èƒ½ä¿®æ”¹èœå–®ã€åº«å­˜

**ä¿®å¾©æ–¹æ¡ˆï¼š**
- âœ… å»ºç«‹ `verify_admin_session()` æ¬Šé™é©—è­‰å‡½æ•¸
- âœ… å»ºç«‹ Admin å°ˆç”¨ RPCï¼š
  - `admin_create_menu_item()` - æ–°å¢èœå–®
  - `admin_update_menu_item()` - æ›´æ–°èœå–®
  - `admin_delete_menu_item()` - åˆªé™¤èœå–®ï¼ˆè»Ÿåˆªé™¤ï¼‰
  - `admin_update_inventory()` - æ›´æ–°åº«å­˜
  - `admin_get_all_orders()` - æŸ¥çœ‹æ‰€æœ‰è¨‚å–®
- âœ… æ‰€æœ‰ Admin RPC éƒ½éœ€è¦ `session_token` + `role = 'admin'` é©—è­‰

**å½±éŸ¿ç¯„åœï¼š**
- `admin.html` éœ€è¦åŠ å…¥ PIN ç™»å…¥ç³»çµ±ï¼ˆå‰ç«¯å°šæœªæ›´æ–°ï¼‰
- æ‰€æœ‰ç®¡ç†æ“ä½œéœ€æ”¹ç”¨æ–°çš„ RPC

---

### 3ï¸âƒ£ **Session Token å®‰å…¨å‡ç´š** ğŸ”

**å•é¡Œï¼š**
- Session token ç¼ºå°‘æ’¤éŠ·æ©Ÿåˆ¶ï¼ˆç„¡æ³•ç™»å‡ºï¼‰
- æ²’æœ‰è¿½è¹¤æœ€å¾Œæ´»å‹•æ™‚é–“
- æ²’æœ‰è¨­å‚™ç®¡ç†åŠŸèƒ½

**ä¿®å¾©æ–¹æ¡ˆï¼š**
- âœ… æ–°å¢ `staff_sessions.revoked_at` æ¬„ä½ï¼ˆç™»å‡ºæ™‚æ’¤éŠ· tokenï¼‰
- âœ… æ–°å¢ `staff_sessions.last_seen_at` æ¬„ä½ï¼ˆè¿½è¹¤æ´»å‹•ï¼‰
- âœ… æ–°å¢ `staff_sessions.device_id` æ¬„ä½ï¼ˆå¤šè¨­å‚™ç®¡ç†ï¼‰
- âœ… å»ºç«‹ç´¢å¼•åŠ é€ŸæŸ¥è©¢

**æœªä¾†å»ºè­°ï¼š**
- Session token æ‡‰è©² hash å­˜å„²ï¼ˆç›®å‰æ˜¯æ˜æ–‡ï¼‰
- å¯è€ƒæ…®ä½¿ç”¨ Supabase Auth å–ä»£è‡ªè£½ session ç³»çµ±

---

### 4ï¸âƒ£ **login_attempts.success æ¬„ä½å‘½åä¿®å¾©**

**å•é¡Œï¼š**
- `success` æ˜¯å¸¸è¦‹åç¨±ï¼Œèˆ‡å‡½æ•¸è¿”å›å€¼è¡çª
- å°è‡´ SQL éŒ¯èª¤ï¼š`ERROR: 42702: column reference "success" is ambiguous`

**ä¿®å¾©æ–¹æ¡ˆï¼š**
- âœ… é‡å‘½åï¼š`success` â†’ `is_success`
- âœ… æ›´æ–°æ‰€æœ‰ç›¸é—œå‡½æ•¸ï¼ˆ`attempt_staff_login`ï¼‰
- âœ… æ˜ç¢ºä½¿ç”¨ `login_attempts.is_success` é¿å…æ­§ç¾©

---

### 5ï¸âƒ£ **åº«å­˜æ‰£é™¤åŸå­æ€§ä¿®å¾©**

**å•é¡Œï¼š**
- `decrement_inventory()` æ²’æœ‰é˜²æ­¢ race condition
- æ²’æœ‰æª¢æŸ¥åº«å­˜æ˜¯å¦è¶³å¤ ï¼ˆå¯èƒ½å‡ºç¾è² æ•¸ï¼‰

**ä¿®å¾©æ–¹æ¡ˆï¼š**
- âœ… ä½¿ç”¨ `FOR UPDATE` é–å®šï¼ˆé˜²æ­¢ä¸¦ç™¼å•é¡Œï¼‰
- âœ… æª¢æŸ¥åº«å­˜æ•¸é‡ï¼ˆé˜²æ­¢è² æ•¸ï¼‰
- âœ… æ¸…æ¥šçš„éŒ¯èª¤è¨Šæ¯ï¼ˆåº«å­˜ä¸è¶³æ™‚ï¼‰
- âœ… æ‰¹æ¬¡åº«å­˜æ‰£é™¤å‡½æ•¸ `decrement_inventory_for_order()`

---

## ğŸ“Š ä¿®å¾©å‰å¾Œå°æ¯”

| é …ç›® | ä¿®å¾©å‰ | ä¿®å¾©å¾Œ |
|------|--------|--------|
| å®¢äººä¸‹å–® | ç›´æ¥ INSERTï¼ˆå¯ç«„æ”¹åƒ¹æ ¼ï¼‰ | RPC é‡æ–°è¨ˆç®—åƒ¹æ ¼ + Rate Limiting |
| Admin ç®¡ç† | anon keyï¼ˆç„¡ä¿è­·ï¼‰ | éœ€è¦ admin session token é©—è­‰ |
| Session ç®¡ç† | ç„¡æ³•æ’¤éŠ·ã€ç„¡è¿½è¹¤ | å¯æ’¤éŠ·ã€æœ‰æ´»å‹•è¨˜éŒ„ã€è¨­å‚™ç®¡ç† |
| ç™»å…¥å®‰å…¨ | success æ¬„ä½æ­§ç¾© | is_success æ˜ç¢ºå‘½å |
| åº«å­˜æ‰£é™¤ | ç„¡é–å®šã€å¯è² æ•¸ | FOR UPDATE é–å®šã€é˜²è² æ•¸ |

---

## ğŸ”„ å»ºç«‹çš„ RPC å‡½æ•¸æ¸…å–®

### å…¬é–‹ RPCï¼ˆanon å¯ç”¨ï¼‰
- `create_public_order()` - å®¢äººä¸‹å–®ï¼ˆæœ‰ Rate Limitingï¼‰

### å“¡å·¥ RPCï¼ˆauthenticatedï¼‰
- `attempt_staff_login()` - å“¡å·¥ç™»å…¥ï¼ˆå·²ä¿®æ­£æ¬„ä½æ­§ç¾©ï¼‰

### Admin RPCï¼ˆéœ€è¦ admin è§’è‰²ï¼‰
- `verify_admin_session()` - é©—è­‰ Admin æ¬Šé™
- `admin_create_menu_item()` - æ–°å¢èœå–®
- `admin_update_menu_item()` - æ›´æ–°èœå–®
- `admin_delete_menu_item()` - åˆªé™¤èœå–®
- `admin_update_inventory()` - æ›´æ–°åº«å­˜
- `admin_get_all_orders()` - æŸ¥çœ‹æ‰€æœ‰è¨‚å–®

### åº«å­˜ RPC
- `decrement_inventory()` - å–®ä¸€åº«å­˜æ‰£é™¤ï¼ˆåŸå­æ€§ï¼‰
- `decrement_inventory_for_order()` - æ‰¹æ¬¡åº«å­˜æ‰£é™¤

---

## ğŸš§ å°šæœªå®Œæˆçš„å·¥ä½œ

### å‰ç«¯æ•´åˆ
1. **pos.html** éœ€è¦æ”¹ç”¨ `create_public_order()` RPC
2. **admin.html** éœ€è¦ï¼š
   - åŠ å…¥ PIN ç™»å…¥ç³»çµ±
   - æ”¹ç”¨ Admin RPCï¼ˆä¸å†ç›´æ¥æ“ä½œè³‡æ–™åº«ï¼‰
3. **employee-pos.html** æ‡‰è©²å·²ç¶“åœ¨ç”¨ RPCï¼ˆéœ€ç¢ºèªï¼‰

### é€²éšå®‰å…¨å»ºè­°
1. **Session Token Hash å­˜å„²**
   - ç›®å‰ `session_token` æ˜¯æ˜æ–‡å­˜åœ¨ DB
   - å»ºè­°ä½¿ç”¨ `digest(token, 'sha256')` å­˜å„²

2. **Audit Log ç³»çµ±**
   - è¨˜éŒ„æ‰€æœ‰ Admin æ“ä½œï¼ˆæ–°å¢/ä¿®æ”¹/åˆªé™¤ï¼‰
   - è¨˜éŒ„åº«å­˜è®Šæ›´æ­·å²

3. **Realtime è¨‚é–±**
   - å»šæˆ¿é¡¯ç¤ºè‡ªå‹•æ›´æ–°æ–°è¨‚å–®
   - å¾Œå°è‡ªå‹•åˆ·æ–°è¨‚å–®åˆ—è¡¨

4. **RLS (Row Level Security) è¨­å®š**
   - ç›®å‰ä¾è³´ RPC + SECURITY DEFINER
   - å¯åŠ å¼· RLS ä½œç‚ºé›™é‡ä¿è­·

---

## ğŸ“ ä¿®å¾© SQL æª”æ¡ˆä½ç½®

æ‰€æœ‰ä¿®å¾© SQL å·²ä¿å­˜åœ¨ï¼š
- `/Users/pc/simple-pos-system/sql-fixes/`

åŒ…å«ï¼š
1. `create-public-order-rpc.sql` - å®¢äººä¸‹å–® RPC
2. `admin-security-rpcs.sql` - Admin å®‰å…¨ RPC
3. `session-token-upgrade.sql` - Session å®‰å…¨å‡ç´š
4. `login-attempts-column-fix.sql` - ç™»å…¥æ¬„ä½ä¿®æ­£
5. `inventory-atomic-fix.sql` - åº«å­˜åŸå­æ€§ä¿®å¾©

---

## ğŸ§ª æ¸¬è©¦å»ºè­°

### 1. æ¸¬è©¦ create_public_order RPC
```sql
-- æ¸¬è©¦æ­£å¸¸ä¸‹å–®
SELECT * FROM create_public_order(
    p_items := '[{"item_id": "å¯¦éš›çš„ UUID", "quantity": 2}]'::JSONB,
    p_order_type := 'dine_in',
    p_payment_method := 'cash',
    p_ip_address := '127.0.0.1'
);

-- æ¸¬è©¦ Rate Limitingï¼ˆé€£çºŒåŸ·è¡Œ 11 æ¬¡ï¼‰
-- ç¬¬ 11 æ¬¡æ‡‰è©²è¢«æ‹’çµ•
```

### 2. æ¸¬è©¦ Admin RPC
```sql
-- å…ˆç”¨ admin PIN ç™»å…¥å–å¾— token
SELECT * FROM attempt_staff_login(
    p_username := '1234',
    p_pin_code := '1234',
    p_ip_address := '127.0.0.1'
);

-- ä½¿ç”¨è¿”å›çš„ session_token æ¸¬è©¦ Admin æ“ä½œ
SELECT * FROM admin_create_menu_item(
    p_session_token := 'ä½ çš„ token',
    p_name := 'æ¸¬è©¦èœå“',
    p_description := 'æ¸¬è©¦',
    p_price := 10.00,
    p_category := 'æ¸¬è©¦'
);
```

### 3. æ¸¬è©¦åº«å­˜æ‰£é™¤
```sql
-- æ¸¬è©¦åº«å­˜ä¸è¶³æƒ…æ³
SELECT * FROM decrement_inventory(
    item_id := 'å¯¦éš›çš„ inventory_item_id',
    quantity := 9999  -- æ•…æ„è¶…éåº«å­˜
);
```

---

## ğŸ“ˆ æ•ˆèƒ½å½±éŸ¿è©•ä¼°

| ä¿®å¾© | æ•ˆèƒ½å½±éŸ¿ | èªªæ˜ |
|------|---------|------|
| create_public_order | è¼•å¾®å¢åŠ  | Rate Limiting æª¢æŸ¥ + åƒ¹æ ¼é‡ç®— |
| Admin RPC | è¼•å¾®å¢åŠ  | Session é©—è­‰ + æ¬Šé™æª¢æŸ¥ |
| Session Token | ç„¡å½±éŸ¿ | åªæ˜¯æ–°å¢æ¬„ä½ |
| login_attempts | ç„¡å½±éŸ¿ | åªæ˜¯æ”¹å |
| åº«å­˜æ‰£é™¤ | è¼•å¾®å¢åŠ  | FOR UPDATE é–å®šï¼Œä½†ä¿è­‰æ­£ç¢ºæ€§ |

**ç¸½é«”è©•ä¼°ï¼š** æ•ˆèƒ½å½±éŸ¿å¯å¿½ç•¥ï¼Œå®‰å…¨æ€§å¤§å¹…æå‡ âœ…

---

## ğŸ¯ ä¸‹ä¸€æ­¥å»ºè­°

### çŸ­æœŸï¼ˆ1-2 é€±ï¼‰
1. âœ… æ›´æ–°å‰ç«¯ä»£ç¢¼ï¼ˆpos.html, admin.htmlï¼‰
2. âœ… æ¸¬è©¦æ‰€æœ‰ä¿®å¾©åŠŸèƒ½
3. âœ… å»ºç«‹ç°¡å–®çš„ Admin ç™»å…¥é é¢

### ä¸­æœŸï¼ˆ1 å€‹æœˆï¼‰
1. åŠ å…¥ Audit Log ç³»çµ±
2. å¯¦ä½œ Realtime è¨‚é–±
3. Session Token Hash å­˜å„²

### é•·æœŸï¼ˆ3 å€‹æœˆï¼‰
1. æ•´åˆ Stripe æ”¯ä»˜
2. æœƒå“¡ç³»çµ±
3. è¡Œå‹• App

---

**ğŸ“ æ–‡ä»¶ç‰ˆæœ¬ï¼š** v1.0
**ğŸ“… æœ€å¾Œæ›´æ–°ï¼š** 2026-02-20
**ğŸ‘¨â€ğŸ’» ç¶­è­·è€…ï¼š** Lee's POS Team
