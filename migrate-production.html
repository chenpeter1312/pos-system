<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç”Ÿäº§ç‰ˆæ•°æ®è¿ç§»å·¥å…·</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Lora', 'Noto Serif TC', serif;
            padding: 40px;
            background: linear-gradient(135deg, #E8DCC8 0%, #F9F5EF 100%);
            min-height: 100vh;
            line-height: 1.6;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(107, 68, 35, 0.15);
        }
        h1 {
            color: #6B4423;
            margin-bottom: 10px;
            font-size: 32px;
        }
        .subtitle {
            color: #8B6F47;
            margin-bottom: 30px;
            font-size: 16px;
        }
        .section {
            background: #f9f9f9;
            padding: 25px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #6B4423;
        }
        .section-title {
            font-weight: bold;
            color: #6B4423;
            margin-bottom: 15px;
            font-size: 18px;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-top: 15px;
        }
        .stat-box {
            background: white;
            padding: 15px;
            border-radius: 6px;
            text-align: center;
            border: 2px solid #E8DCC8;
        }
        .stat-label {
            color: #666;
            font-size: 14px;
            margin-bottom: 5px;
        }
        .stat-value {
            color: #6B4423;
            font-size: 28px;
            font-weight: bold;
        }
        button {
            background: linear-gradient(135deg, #8B6F47 0%, #6B4423 100%);
            color: white;
            border: none;
            padding: 14px 28px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
            font-family: 'Lora', 'Noto Serif TC', serif;
            transition: all 0.3s;
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(107, 68, 35, 0.3);
        }
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        button.danger {
            background: linear-gradient(135deg, #C1272D 0%, #A01F23 100%);
        }
        button.secondary {
            background: linear-gradient(135deg, #666 0%, #444 100%);
        }
        #log {
            background: #1e293b;
            color: #e2e8f0;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            max-height: 500px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .log-success { color: #4ade80; }
        .log-error { color: #f87171; }
        .log-warning { color: #fbbf24; }
        .log-info { color: #60a5fa; }
        .button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .alert-success {
            background: #d1fae5;
            color: #065f46;
            border: 2px solid #059669;
        }
        .alert-error {
            background: #fee2e2;
            color: #991b1b;
            border: 2px solid #dc2626;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸš€ ç”Ÿäº§ç‰ˆæ•°æ®è¿ç§»å·¥å…·</h1>
        <p class="subtitle">localStorage â†’ Supabase äº‘ç«¯æ•°æ®åº“ | Safari ä¼˜åŒ–ç‰ˆ</p>

        <div class="section">
            <div class="section-title">ğŸ“Š æœ¬åœ°æ•°æ®ç»Ÿè®¡</div>
            <div class="stats">
                <div class="stat-box">
                    <div class="stat-label">ğŸ± èœå•</div>
                    <div class="stat-value" id="menu-count">-</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">âš™ï¸ é€‰é¡¹</div>
                    <div class="stat-value" id="options-count">-</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">ğŸ“¦ è®¢å•</div>
                    <div class="stat-value" id="orders-count">-</div>
                </div>
            </div>
        </div>

        <div class="section">
            <div class="section-title">ğŸ”§ æ“ä½œ</div>
            <div class="button-group">
                <button onclick="checkConnection()" id="check-btn">
                    1ï¸âƒ£ æ£€æŸ¥ Supabase è¿æ¥
                </button>
                <button onclick="previewMigration()" id="preview-btn">
                    2ï¸âƒ£ é¢„è§ˆè¿ç§»æ•°æ®
                </button>
                <button onclick="startMigration()" id="migrate-btn">
                    3ï¸âƒ£ å¼€å§‹è¿ç§»
                </button>
                <button onclick="clearLog()" class="secondary">
                    æ¸…ç©ºæ—¥å¿—
                </button>
                <button onclick="clearSupabase()" class="danger">
                    âš ï¸ æ¸…ç©º Supabase æ•°æ®
                </button>
            </div>
        </div>

        <pre id="log"></pre>
    </div>

    <script>
        // ==========================================
        // Supabase é…ç½®
        // ==========================================
        var SUPABASE_URL = 'https://tskelejztsdeewtpjcoq.supabase.co';
        var SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRza2VsZWp6dHNkZWV3dHBqY29xIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzExOTUxNjUsImV4cCI6MjA4Njc3MTE2NX0.WFGyeBVRIXfrA9h2BVwQ9zpbmcHDXmI0xsFfdDVdGos';

        var supabase = null;
        var logElement = null;
        var supabaseLoaded = false;

        // ==========================================
        // åŠ¨æ€åŠ è½½ Supabase CDNï¼ˆç¡®ä¿æˆåŠŸåŠ è½½ï¼‰
        // ==========================================
        (function loadSupabaseLib() {
            var script = document.createElement('script');
            script.src = 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.js';

            script.onload = function() {
                console.log('âœ… Supabase CDN åŠ è½½æˆåŠŸ');
                supabaseLoaded = true;

                // ç«‹å³åˆå§‹åŒ–å®¢æˆ·ç«¯
                if (window.supabase && window.supabase.createClient) {
                    try {
                        supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                        console.log('âœ… Supabase å®¢æˆ·ç«¯åˆå§‹åŒ–æˆåŠŸ');

                        // å¦‚æœé¡µé¢å·²åŠ è½½å®Œæˆï¼Œæ›´æ–°æ—¥å¿—
                        if (logElement) {
                            log('âœ… Supabase å®¢æˆ·ç«¯åˆå§‹åŒ–æˆåŠŸ', 'success');
                        }
                    } catch (e) {
                        console.error('âŒ Supabase åˆå§‹åŒ–å¤±è´¥:', e);
                        if (logElement) {
                            log('âŒ Supabase åˆå§‹åŒ–å¤±è´¥: ' + e.message, 'error');
                        }
                    }
                }
            };

            script.onerror = function() {
                console.error('âŒ Supabase CDN åŠ è½½å¤±è´¥');
                if (logElement) {
                    log('âŒ Supabase CDN åŠ è½½å¤±è´¥', 'error');
                }
            };

            document.head.appendChild(script);
        })();

        // ==========================================
        // æ—¥å¿—ç³»ç»Ÿ
        // ==========================================
        function log(message, type) {
            if (!type) type = 'info';

            var timestamp = new Date().toLocaleTimeString('zh-CN');
            var className = 'log-' + type;
            var line = '[' + timestamp + '] ' + message + '\n';

            if (logElement) {
                var span = document.createElement('span');
                span.className = className;
                span.textContent = line;
                logElement.appendChild(span);
                logElement.scrollTop = logElement.scrollHeight;
            }

            console.log('[' + type + '] ' + message);
        }

        function clearLog() {
            if (logElement) {
                logElement.textContent = '';
            }
            log('æ—¥å¿—å·²æ¸…ç©º', 'info');
        }

        // ==========================================
        // SHA-256 å“ˆå¸Œå‡½æ•° (ç”¨äºå¹‚ç­‰æ€§)
        // ==========================================
        async function generateHash(data) {
            var jsonString = JSON.stringify(data);
            var encoder = new TextEncoder();
            var dataBuffer = encoder.encode(jsonString);
            var hashBuffer = await crypto.subtle.digest('SHA-256', dataBuffer);
            var hashArray = Array.from(new Uint8Array(hashBuffer));
            var hashHex = hashArray.map(function(b) {
                return b.toString(16).padStart(2, '0');
            }).join('');
            return hashHex;
        }

        // ==========================================
        // ç¬¬ä¸€å±‚ï¼šä» localStorage æå–æ•°æ®
        // ==========================================
        function extractFromLocalStorage() {
            log('=== å¼€å§‹æå– localStorage æ•°æ® ===', 'info');

            var extracted = {
                menu: [],
                options: [],
                orders: []
            };

            try {
                var menuRaw = localStorage.getItem('menu');
                if (menuRaw) {
                    try {
                        extracted.menu = JSON.parse(menuRaw);
                        log('âœ… æå–èœå•: ' + extracted.menu.length + ' ä¸ª', 'success');
                    } catch (e) {
                        log('âŒ èœå•æ•°æ®è§£æå¤±è´¥: ' + e.message, 'error');
                        extracted.menu = [];
                    }
                } else {
                    log('âš ï¸ localStorage ä¸­æ²¡æœ‰èœå•æ•°æ®', 'warning');
                }
            } catch (e) {
                log('âŒ è¯»å–èœå•å¤±è´¥: ' + e.message, 'error');
            }

            try {
                var optionsRaw = localStorage.getItem('optionsLibrary');
                if (optionsRaw) {
                    try {
                        extracted.options = JSON.parse(optionsRaw);
                        log('âœ… æå–é€‰é¡¹åº“: ' + extracted.options.length + ' ä¸ª', 'success');
                    } catch (e) {
                        log('âŒ é€‰é¡¹åº“æ•°æ®è§£æå¤±è´¥: ' + e.message, 'error');
                        extracted.options = [];
                    }
                } else {
                    log('âš ï¸ localStorage ä¸­æ²¡æœ‰é€‰é¡¹åº“æ•°æ®', 'warning');
                }
            } catch (e) {
                log('âŒ è¯»å–é€‰é¡¹åº“å¤±è´¥: ' + e.message, 'error');
            }

            try {
                var ordersRaw = localStorage.getItem('orders');
                if (ordersRaw) {
                    try {
                        extracted.orders = JSON.parse(ordersRaw);
                        log('âœ… æå–è®¢å•: ' + extracted.orders.length + ' ä¸ª', 'success');
                    } catch (e) {
                        log('âŒ è®¢å•æ•°æ®è§£æå¤±è´¥: ' + e.message, 'error');
                        extracted.orders = [];
                    }
                } else {
                    log('âš ï¸ localStorage ä¸­æ²¡æœ‰è®¢å•æ•°æ®', 'warning');
                }
            } catch (e) {
                log('âŒ è¯»å–è®¢å•å¤±è´¥: ' + e.message, 'error');
            }

            return extracted;
        }

        // ==========================================
        // ç¬¬äºŒå±‚ï¼šè½¬æ¢ä¸ºæ•°æ®åº“è¡Œæ ¼å¼
        // ==========================================
        async function transformToRows(extracted) {
            log('=== å¼€å§‹è½¬æ¢æ•°æ®æ ¼å¼ ===', 'info');

            var transformed = {
                menuRows: [],
                optionsRows: [],
                ordersRows: []
            };

            // è½¬æ¢èœå•
            for (var i = 0; i < extracted.menu.length; i++) {
                var item = extracted.menu[i];
                try {
                    var menuRow = {
                        id: item.id,
                        name: item.name,
                        english_name: item.englishName || null,
                        price: item.price,
                        category: item.category,
                        emoji: item.emoji || null,
                        image: item.image || null,
                        description: item.description || null,
                        available: item.available !== false,
                        applied_option_ids: item.appliedOptionIds || []
                    };
                    transformed.menuRows.push(menuRow);
                } catch (e) {
                    log('âš ï¸ èœå•é¡¹è½¬æ¢å¤±è´¥ (ID: ' + item.id + '): ' + e.message, 'warning');
                }
            }
            log('âœ… èœå•è½¬æ¢å®Œæˆ: ' + transformed.menuRows.length + ' è¡Œ', 'success');

            // è½¬æ¢é€‰é¡¹åº“
            for (var j = 0; j < extracted.options.length; j++) {
                var opt = extracted.options[j];
                try {
                    var optRow = {
                        id: opt.id,
                        name: opt.name,
                        type: opt.type,
                        required: opt.required || false,
                        is_enabled: opt.isEnabled !== false,
                        categories: opt.categories || [],
                        choices: opt.choices
                    };
                    transformed.optionsRows.push(optRow);
                } catch (e) {
                    log('âš ï¸ é€‰é¡¹è½¬æ¢å¤±è´¥ (ID: ' + opt.id + '): ' + e.message, 'warning');
                }
            }
            log('âœ… é€‰é¡¹åº“è½¬æ¢å®Œæˆ: ' + transformed.optionsRows.length + ' è¡Œ', 'success');

            // è½¬æ¢è®¢å•
            for (var k = 0; k < extracted.orders.length; k++) {
                var order = extracted.orders[k];
                try {
                    var orderRow = {
                        id: order.id,
                        customer_name: order.customerName || null,
                        phone: order.phone || null,
                        service_mode: order.serviceMode || null,
                        items: order.items,
                        total: order.total,
                        status: order.status || 'pending',
                        notes: order.notes || null,
                        scheduled_time: order.scheduledTime || null,
                        created_at: order.timestamp || new Date().toISOString()
                    };
                    transformed.ordersRows.push(orderRow);
                } catch (e) {
                    log('âš ï¸ è®¢å•è½¬æ¢å¤±è´¥ (ID: ' + order.id + '): ' + e.message, 'warning');
                }
            }
            log('âœ… è®¢å•è½¬æ¢å®Œæˆ: ' + transformed.ordersRows.length + ' è¡Œ', 'success');

            return transformed;
        }

        // ==========================================
        // ç¬¬ä¸‰å±‚ï¼šåŠ è½½åˆ° Supabase
        // ==========================================
        async function loadToSupabase(transformed) {
            log('=== å¼€å§‹åŠ è½½åˆ° Supabase ===', 'info');

            if (!supabase) {
                throw new Error('Supabase å®¢æˆ·ç«¯æœªåˆå§‹åŒ–');
            }

            var results = {
                menu: 0,
                options: 0,
                orders: 0
            };

            // ä¸Šä¼ é€‰é¡¹åº“ (å…ˆä¸Šä¼ ï¼Œå› ä¸ºèœå•ä¾èµ–å®ƒ)
            if (transformed.optionsRows.length > 0) {
                log('æ­£åœ¨ä¸Šä¼ é€‰é¡¹åº“...', 'info');
                var optResponse = await supabase
                    .from('options_library')
                    .upsert(transformed.optionsRows, { onConflict: 'id' });

                if (optResponse.error) {
                    throw new Error('é€‰é¡¹åº“ä¸Šä¼ å¤±è´¥: ' + optResponse.error.message);
                }
                results.options = transformed.optionsRows.length;
                log('âœ… é€‰é¡¹åº“ä¸Šä¼ æˆåŠŸ: ' + results.options + ' è¡Œ', 'success');
            }

            // ä¸Šä¼ èœå•
            if (transformed.menuRows.length > 0) {
                log('æ­£åœ¨ä¸Šä¼ èœå•...', 'info');
                var menuResponse = await supabase
                    .from('menu')
                    .upsert(transformed.menuRows, { onConflict: 'id' });

                if (menuResponse.error) {
                    throw new Error('èœå•ä¸Šä¼ å¤±è´¥: ' + menuResponse.error.message);
                }
                results.menu = transformed.menuRows.length;
                log('âœ… èœå•ä¸Šä¼ æˆåŠŸ: ' + results.menu + ' è¡Œ', 'success');
            }

            // ä¸Šä¼ è®¢å•
            if (transformed.ordersRows.length > 0) {
                log('æ­£åœ¨ä¸Šä¼ è®¢å•...', 'info');
                var ordersResponse = await supabase
                    .from('orders')
                    .upsert(transformed.ordersRows, { onConflict: 'id' });

                if (ordersResponse.error) {
                    throw new Error('è®¢å•ä¸Šä¼ å¤±è´¥: ' + ordersResponse.error.message);
                }
                results.orders = transformed.ordersRows.length;
                log('âœ… è®¢å•ä¸Šä¼ æˆåŠŸ: ' + results.orders + ' è¡Œ', 'success');
            }

            return results;
        }

        // ==========================================
        // Supabase åˆå§‹åŒ–æ£€æŸ¥ï¼ˆç¡®ä¿åº“å·²åŠ è½½ï¼‰
        // ==========================================
        function ensureSupabaseInitialized() {
            if (supabase) {
                return true;
            }

            if (!supabaseLoaded) {
                log('âŒ Supabase åº“è¿˜åœ¨åŠ è½½ä¸­ï¼Œè¯·ç¨åå†è¯•', 'error');
                return false;
            }

            if (!window.supabase) {
                log('âŒ Supabase åº“åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•', 'error');
                return false;
            }

            // å°è¯•å»¶è¿Ÿåˆå§‹åŒ–
            try {
                log('åˆå§‹åŒ– Supabase å®¢æˆ·ç«¯...', 'info');
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                log('âœ… Supabase å®¢æˆ·ç«¯åˆå§‹åŒ–æˆåŠŸ', 'success');
                return true;
            } catch (e) {
                log('âŒ Supabase åˆå§‹åŒ–å¤±è´¥: ' + e.message, 'error');
                return false;
            }
        }

        // ==========================================
        // UI æ“ä½œå‡½æ•°
        // ==========================================

        function checkConnection() {
            log('\n=== æ£€æŸ¥ Supabase è¿æ¥ ===', 'info');

            if (!ensureSupabaseInitialized()) {
                return;
            }

            var btn = document.getElementById('check-btn');
            btn.disabled = true;
            btn.textContent = 'æ£€æŸ¥ä¸­...';

            supabase.from('menu')
                .select('*', { count: 'exact', head: true })
                .then(function(response) {
                    if (response.error) {
                        throw response.error;
                    }

                    var menuCount = response.count || 0;
                    log('âœ… è¿æ¥æˆåŠŸï¼', 'success');
                    log('menu è¡¨å½“å‰æœ‰ ' + menuCount + ' æ¡è®°å½•', 'info');

                    return Promise.all([
                        supabase.from('options_library').select('*', { count: 'exact', head: true }),
                        supabase.from('orders').select('*', { count: 'exact', head: true })
                    ]);
                })
                .then(function(responses) {
                    var optCount = responses[0].count || 0;
                    var ordCount = responses[1].count || 0;

                    log('options_library è¡¨å½“å‰æœ‰ ' + optCount + ' æ¡è®°å½•', 'info');
                    log('orders è¡¨å½“å‰æœ‰ ' + ordCount + ' æ¡è®°å½•', 'info');
                    log('=== æ£€æŸ¥å®Œæˆ ===\n', 'success');
                })
                .catch(function(error) {
                    log('âŒ è¿æ¥å¤±è´¥: ' + error.message, 'error');
                    log('è¯·æ£€æŸ¥ï¼š1) é…ç½®æ˜¯å¦æ­£ç¡® 2) è¡¨æ˜¯å¦åˆ›å»º 3) RLSç­–ç•¥æ˜¯å¦è®¾ç½®', 'warning');
                })
                .finally(function() {
                    btn.disabled = false;
                    btn.textContent = '1ï¸âƒ£ æ£€æŸ¥ Supabase è¿æ¥';
                });
        }

        function previewMigration() {
            log('\n=== é¢„è§ˆè¿ç§»æ•°æ® ===', 'info');

            var extracted = extractFromLocalStorage();

            log('\nğŸ“Š æ•°æ®ç»Ÿè®¡ï¼š', 'info');
            log('ğŸ± èœå•: ' + extracted.menu.length + ' ä¸ª', 'info');
            log('âš™ï¸ é€‰é¡¹åº“: ' + extracted.options.length + ' ä¸ª', 'info');
            log('ğŸ“¦ è®¢å•: ' + extracted.orders.length + ' ä¸ª', 'info');

            if (extracted.menu.length > 0) {
                log('\nğŸ± èœå•é¡¹ç¤ºä¾‹ (å‰3ä¸ª):', 'info');
                for (var i = 0; i < Math.min(3, extracted.menu.length); i++) {
                    var item = extracted.menu[i];
                    log('  - ' + item.name + ' ($' + item.price + ')', 'info');
                }
            }

            if (extracted.options.length > 0) {
                log('\nâš™ï¸ é€‰é¡¹ç¤ºä¾‹ (å‰3ä¸ª):', 'info');
                for (var j = 0; j < Math.min(3, extracted.options.length); j++) {
                    var opt = extracted.options[j];
                    log('  - ' + opt.name + ' (' + opt.type + ')', 'info');
                }
            }

            log('\nâœ… é¢„è§ˆå®Œæˆï¼ç‚¹å‡»ã€Œå¼€å§‹è¿ç§»ã€è¿›è¡Œè¿ç§»', 'success');
        }

        function startMigration() {
            if (!confirm('ç¡®å®šè¦å¼€å§‹è¿ç§»æ•°æ®å—ï¼Ÿ\n\nè¿™å°†æŠŠ localStorage çš„æ•°æ®ä¸Šä¼ åˆ° Supabaseã€‚')) {
                return;
            }

            if (!ensureSupabaseInitialized()) {
                return;
            }

            log('\n========================================', 'info');
            log('å¼€å§‹è¿ç§»æµç¨‹', 'info');
            log('========================================\n', 'info');

            var btn = document.getElementById('migrate-btn');
            btn.disabled = true;
            btn.textContent = 'è¿ç§»ä¸­...';

            var startTime = Date.now();
            var extracted = null;
            var transformed = null;

            Promise.resolve()
                .then(function() {
                    // ç¬¬ä¸€æ­¥ï¼šæå–
                    extracted = extractFromLocalStorage();
                    return extracted;
                })
                .then(function() {
                    // ç¬¬äºŒæ­¥ï¼šè½¬æ¢
                    return transformToRows(extracted);
                })
                .then(function(transformedData) {
                    transformed = transformedData;
                    // ç¬¬ä¸‰æ­¥ï¼šåŠ è½½
                    return loadToSupabase(transformed);
                })
                .then(function(results) {
                    var duration = ((Date.now() - startTime) / 1000).toFixed(2);

                    log('\n========================================', 'success');
                    log('ğŸ‰ è¿ç§»å®Œæˆï¼', 'success');
                    log('========================================', 'success');
                    log('âœ… èœå•: ' + results.menu + ' è¡Œ', 'success');
                    log('âœ… é€‰é¡¹åº“: ' + results.options + ' è¡Œ', 'success');
                    log('âœ… è®¢å•: ' + results.orders + ' è¡Œ', 'success');
                    log('â±ï¸ ç”¨æ—¶: ' + duration + ' ç§’', 'info');
                    log('\nç°åœ¨å¯ä»¥ä¿®æ”¹ä»£ç ä½¿ç”¨ Supabase API äº†ï¼', 'info');
                })
                .catch(function(error) {
                    log('\nâŒ è¿ç§»å¤±è´¥: ' + error.message, 'error');
                    if (error.stack) {
                        log('é”™è¯¯å †æ ˆ: ' + error.stack, 'error');
                    }
                })
                .finally(function() {
                    btn.disabled = false;
                    btn.textContent = '3ï¸âƒ£ å¼€å§‹è¿ç§»';
                });
        }

        function clearSupabase() {
            if (!confirm('âš ï¸ è­¦å‘Šï¼šè¿™å°†åˆ é™¤ Supabase ä¸­çš„æ‰€æœ‰æ•°æ®ï¼\n\nç¡®å®šç»§ç»­å—ï¼Ÿ')) {
                return;
            }

            if (!confirm('å†æ¬¡ç¡®è®¤ï¼šçœŸçš„è¦æ¸…ç©ºæ‰€æœ‰ Supabase æ•°æ®å—ï¼Ÿ\n\næ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
                return;
            }

            if (!ensureSupabaseInitialized()) {
                return;
            }

            log('\n=== å¼€å§‹æ¸…ç©º Supabase æ•°æ® ===', 'warning');

            Promise.resolve()
                .then(function() {
                    log('æ­£åœ¨æ¸…ç©ºè®¢å•...', 'info');
                    return supabase.from('orders').delete().neq('id', 0);
                })
                .then(function(response) {
                    if (response.error) throw response.error;
                    log('âœ… è®¢å•å·²æ¸…ç©º', 'success');

                    log('æ­£åœ¨æ¸…ç©ºèœå•...', 'info');
                    return supabase.from('menu').delete().neq('id', 0);
                })
                .then(function(response) {
                    if (response.error) throw response.error;
                    log('âœ… èœå•å·²æ¸…ç©º', 'success');

                    log('æ­£åœ¨æ¸…ç©ºé€‰é¡¹åº“...', 'info');
                    return supabase.from('options_library').delete().neq('id', 0);
                })
                .then(function(response) {
                    if (response.error) throw response.error;
                    log('âœ… é€‰é¡¹åº“å·²æ¸…ç©º', 'success');
                    log('\n=== æ¸…ç©ºå®Œæˆ ===\n', 'success');
                })
                .catch(function(error) {
                    log('âŒ æ¸…ç©ºå¤±è´¥: ' + error.message, 'error');
                });
        }

        // ==========================================
        // é¡µé¢åˆå§‹åŒ–
        // ==========================================
        window.onload = function() {
            log('é¡µé¢åŠ è½½å®Œæˆ', 'info');
            logElement = document.getElementById('log');

            // æ£€æŸ¥ Supabase æ˜¯å¦å·²åŠ è½½
            if (supabaseLoaded && supabase) {
                log('âœ… Supabase å®¢æˆ·ç«¯å·²å°±ç»ª', 'success');
            } else if (supabaseLoaded) {
                log('âš ï¸ Supabase åº“å·²åŠ è½½ï¼Œä½†å®¢æˆ·ç«¯æœªåˆå§‹åŒ–', 'warning');
            } else {
                log('â³ ç­‰å¾… Supabase åº“åŠ è½½ä¸­...', 'info');
            }

            // è¯»å–å¹¶æ˜¾ç¤ºæœ¬åœ°æ•°æ®ç»Ÿè®¡
            try {
                var menu = [];
                var options = [];
                var orders = [];

                try {
                    var menuRaw = localStorage.getItem('menu');
                    if (menuRaw) menu = JSON.parse(menuRaw);
                } catch (e) {
                    log('âš ï¸ è¯»å–èœå•å¤±è´¥: ' + e.message, 'warning');
                }

                try {
                    var optionsRaw = localStorage.getItem('optionsLibrary');
                    if (optionsRaw) options = JSON.parse(optionsRaw);
                } catch (e) {
                    log('âš ï¸ è¯»å–é€‰é¡¹åº“å¤±è´¥: ' + e.message, 'warning');
                }

                try {
                    var ordersRaw = localStorage.getItem('orders');
                    if (ordersRaw) orders = JSON.parse(ordersRaw);
                } catch (e) {
                    log('âš ï¸ è¯»å–è®¢å•å¤±è´¥: ' + e.message, 'warning');
                }

                document.getElementById('menu-count').textContent = menu.length;
                document.getElementById('options-count').textContent = options.length;
                document.getElementById('orders-count').textContent = orders.length;

                log('âœ… localStorage æ•°æ®è¯»å–æˆåŠŸ', 'success');
                log('ğŸ“Š èœå•: ' + menu.length + ' | é€‰é¡¹: ' + options.length + ' | è®¢å•: ' + orders.length, 'info');
                log('\nå‡†å¤‡å°±ç»ªï¼è¯·ç‚¹å‡»æŒ‰é’®å¼€å§‹æ“ä½œ ğŸ‘†\n', 'success');
            } catch (e) {
                log('âŒ è¯»å– localStorage å¤±è´¥: ' + e.message, 'error');
            }
        };
    </script>
</body>
</html>
